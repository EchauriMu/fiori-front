<mvc:View
    controllerName="com.invertions.sapfiorimodinv.controller.listasprecios.CrearLista"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:l="sap.ui.layout"
    xmlns:core="sap.ui.core"
    height="100%">
    
    <Page
        id="crearListaPage"
        title="Crear Nueva Lista de Precios"
        showNavButton="true"
        navButtonPress=".onNavBack"
        class="sapUiResponsiveContentPadding">
        
        <content>
            <ScrollContainer height="100%" width="100%" vertical="true" horizontal="false">
                <VBox class="sapUiMediumMargin">
                    
                    <!-- Wizard con 2 pasos -->
                    <Wizard
                        id="wizardCrearLista"
                        complete=".onWizardComplete"
                        currentStep="{wizardModel>/currentStep}"
                        width="100%"
                        class="sapUiResponsiveMargin">
                        
                        <!-- PASO 1: Datos Generales -->
                        <WizardStep
                            id="step1Config"
                            title="Datos Generales"
                            validated="true">
                            
                            <VBox width="100%" alignItems="Center" class="sapUiSmallMargin">
                                <!-- Contenedor centrado del formulario -->
                                <VBox width="45em" class="sapUiSmallMargin">
                                    <Title text="Información General" level="H3" class="sapUiSmallMarginBottom"/>
                                    
                                    <HBox>
                                        <VBox width="70%">
                                            <Label text="Descripción de la Lista" required="true" class="sapUiTinyMarginTop"/>
                                            <Input
                                                id="inputDESLISTA"
                                                value="{wizardModel>/DESLISTA}"
                                                placeholder="Ej: Lista de Precios Retail 2025"
                                                required="true"
                                                change=".onDescriptionChange"
                                                liveChange=".onValidateStep1"
                                                width="100%"
                                                maxLength="100"/>
                                        </VBox>
                                        <VBox width="30%" class="sapUiSmallMarginStart">
                                            <Label text="ID (Autogenerado)" class="sapUiTinyMarginTop"/>
                                            <Input
                                                id="inputIDLISTA"
                                                value="{wizardModel>/IDLISTAOK}"
                                                enabled="false"
                                                width="100%"/>
                                        </VBox>
                                    </HBox>
                                    
                                    <Label text="Instituto" required="true" class="sapUiTinyMarginTop"/>
                                    <Input
                                        id="inputINSTITUTO"
                                        value="{wizardModel>/IDINSTITUTOOK}"
                                        placeholder="Ej: INST-001"
                                        required="true"
                                        change=".onValidateStep1"
                                        liveChange=".onValidateStep1"
                                        width="100%"
                                        maxLength="50"/>
                                    
                                    <Label text="Tipo de Lista" class="sapUiTinyMarginTop"/>
                                    <Select
                                        id="selectTipoLista"
                                        selectedKey="{wizardModel>/IDTIPOLISTAOK}"
                                        change=".onTipoListaChange"
                                        width="100%">
                                        <items>
                                            <core:Item key="" text="Seleccionar tipo..."/>
                                            <core:Item key="LISTA_BASE" text="Lista Base"/>
                                            <core:Item key="LISTA_MAYORISTA" text="Lista Mayorista"/>
                                            <core:Item key="LISTA_MINORISTA" text="Lista Minorista"/>
                                            <core:Item key="LISTA_PROMOCIONAL" text="Lista Promocional"/>
                                            <core:Item key="LISTA_VIP" text="Lista VIP"/>
                                            <core:Item key="LISTA_ESTACIONAL" text="Lista Estacional"/>
                                            <core:Item key="LISTA_POR_REGION" text="Lista por Región"/>
                                            <core:Item key="LISTA_POR_CANAL" text="Lista por Canal"/>
                                            <core:Item key="LISTA_COSTO" text="Lista de Costo"/>
                                            <core:Item key="LISTA_ESPECIAL" text="Lista Especial"/>
                                        </items>
                                    </Select>
                                    
                                    <Label text="Tipo general de lista" class="sapUiTinyMarginTop"/>
                                    <Select
                                        id="selectTipoGeneralLista"
                                        selectedKey="{wizardModel>/IDTIPOGENERALISTAOK}"
                                        change=".onTipoGeneralChange"
                                        width="100%">
                                        <items>
                                            <core:Item key="" text="Seleccionar tipo..."/>
                                            <core:Item key="ESPECIFICA" text="Específica"/>
                                            <core:Item key="GENERAL" text="General"/>
                                        </items>
                                    </Select>
                                    
                                    <Label text="Tipo de Fórmula" required="true" class="sapUiTinyMarginTop"/>
                                    <Select
                                        id="selectTipoFormula"
                                        selectedKey="{wizardModel>/IDTIPOFORMULAOK}"
                                        change=".onTipoFormulaChange"
                                        required="true"
                                        liveChange=".onValidateStep1"
                                        width="100%">
                                        <items>
                                            <core:Item key="" text="Seleccionar tipo..."/>
                                            <core:Item key="FORMULA_DESCUENTO" text="Fórmula Descuento"/>
                                            <core:Item key="FORMULA_MAYORISTA" text="Fórmula Mayorista"/>
                                            <core:Item key="FORMULA_ESTANDAR" text="Fórmula Estándar"/>
                                            <core:Item key="FORMULA_PAQUETE" text="Fórmula Paquete"/>
                                        </items>
                                    </Select>
                                    
                                    <Title text="Vigencia" level="H3" class="sapUiSmallMarginTop"/>
                                    
                                    <Label text="Fecha Inicio" required="true" class="sapUiTinyMarginTop"/>
                                    <DatePicker
                                        id="dateInicio"
                                        value="{wizardModel>/FECHAEXPIRAINI}"
                                        displayFormat="dd/MM/yyyy"
                                        valueFormat="yyyy-MM-dd"
                                        change=".onValidateStep1"
                                        width="100%"/>
                                    
                                    <Label text="Fecha Fin" required="true" class="sapUiTinyMarginTop"/>
                                    <DatePicker
                                        id="dateFin"
                                        value="{wizardModel>/FECHAEXPIRAFIN}"
                                        displayFormat="dd/MM/yyyy"
                                        valueFormat="yyyy-MM-dd"
                                        change=".onValidateStep1"
                                        width="100%"/>
                                </VBox>
                            </VBox>
                        </WizardStep>
                        
                        <!-- PASO 2: Selección de Productos y Fórmula -->
                        <WizardStep
                            id="step2Filtros"
                            title="Selecciona los Productos"
                            validated="false">
                            
                            <VBox class="sapUiSmallMargin" height="100%">
                                <!-- Layout principal: 25% filtros, 75% tabla -->
                                <HBox width="100%" height="100%" alignItems="Stretch">
                                    
                                    <VBox width="25%" class="sapUiMediumMarginEnd" height="100%">
                                        <Title text="Filtros Avanzados" level="H5" class="sapUiSmallMarginBottom"/>
                                        
                                        <HBox alignItems="Center" class="sapUiSmallMarginBottom">
                                            <Label text="{= ${wizardModel>/activeFilterCount} + ' filtros activos'}" class="sapUiTinyMarginEnd"/>
                                            <ToolbarSpacer/>
                                            <Button
                                                text="Limpiar Filtros"
                                                icon="sap-icon://clear-filter"
                                                press=".onClearFilters"
                                                type="Emphasized"
                                                width="auto"/>
                                        </HBox>
                                        
                                        <!-- Marcas (MultiComboBox) -->
                                        <VBox class="sapUiSmallMarginTop">
                                            <Label text="Marcas de Productos:" class="sapUiTinyMarginBottom"/>
                                            <MultiComboBox
                                                id="comboMarcas"
                                                selectedKeys="{wizardModel>/selectedMarcas}"
                                                selectionChange=".onMarcasChange"
                                                width="100%"
                                                placeholder="Seleccionar marcas..."
                                                items="{wizardModel>/availableMarcas}">
                                                <core:Item key="{wizardModel>name}" text="{wizardModel>name}"/>
                                            </MultiComboBox>
                                        </VBox>
                                        
                                        <!-- Categorías (MultiComboBox) -->
                                        <VBox class="sapUiSmallMarginTop">
                                            <Label text="Categorías de Productos:" class="sapUiTinyMarginBottom"/>
                                            <MultiComboBox
                                                id="comboCategorias"
                                                selectedKeys="{wizardModel>/selectedCategories}"
                                                selectionChange=".onCategoriasChange"
                                                width="100%"
                                                placeholder="Seleccionar categorías..."
                                                items="{wizardModel>/allCategories}">
                                                <core:Item key="{wizardModel>name}" text="{wizardModel>name}"/>
                                            </MultiComboBox>
                                        </VBox>
                                        
                                    </VBox>
                                    
                                    <!-- COLUMNA DERECHA: Productos (75%) - PAGINADA -->
                                    <VBox width="75%" class="sapUiSmallMarginTop" height="100%">
                                        
                                        <!-- Buscador - ARRIBA -->
                                        <VBox class="sapUiSmallMarginBottom">
                                            <Title text="Buscar productos" level="H4" class="sapUiSmallMarginBottom"/>
                                            <SearchField
                                                value="{wizardModel>/searchTerm}"
                                                placeholder="Buscar por nombre, SKU, marca o categoría..."
                                                width="100%"
                                                search=".onSearchProduct"
                                                liveChange=".onSearchProduct"/>
                                        </VBox>
                                        
                                        <!-- Checkbox Seleccionar Todos + Contador -->
                                        <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiSmallMarginBottom">
                                            <HBox alignItems="Center">
                                                <CheckBox
                                                    selected="{= ${wizardModel>/selectedProductsCount} > 0 &amp;&amp; ${wizardModel>/selectedProductsCount} === ${wizardModel>/availableProductsInList}.length }"
                                                    select=".onSelectAllProducts"/>
                                                <Label text="Seleccionar todos ({= ${wizardModel>/availableProductsInList}.length })" class="sapUiSmallMarginStart"/>
                                            </HBox>
                                            <HBox alignItems="Center">
                                                <Label text="{= ${wizardModel>/selectedProductsCount} + ' producto(s) seleccionado(s)'}" class="sapUiTinyMarginEnd"/>
                                            </HBox>
                                        </HBox>
                                        
                                        <!-- SECCIÓN: PRODUCTOS SELECCIONADOS (PILA) - COMPACTA -->
                                        <VBox visible="{= ${wizardModel>/selectedProductsInPile}.length > 0 }" class="sapUiSmallMarginBottom">
                                            <Title text="Seleccionados ({= ${wizardModel>/selectedProductsInPile}.length })" level="H6" class="sapUiTinyMarginBottom"/>
                                            <List
                                                id="selectedProductsList"
                                                items="{wizardModel>/selectedProductsInPile}"
                                                width="100%"
                                                noDataText="">
                                                
                                                <CustomListItem
                                                    type="Inactive"
                                                    class="productLineItem selectedLineItem">
                                                    
                                                    <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%" class="productLineContent">
                                                        <HBox alignItems="Center" width="100%">
                                                            <CheckBox
                                                                selected="{wizardModel>_selected}"
                                                                select=".onProductSelect"
                                                                class="productLineCheckbox"/>
                                                            <VBox class="productLineInfo" width="100%">
                                                                <HBox>
                                                                    <Text
                                                                        text="{wizardModel>PRODUCTNAME}"
                                                                        class="productLineName"
                                                                        wrapping="false"/>
                                                                    <ToolbarSpacer/>
                                                                    <Text text="11/21/2025" class="sapUiTinyMarginStart sapUiTinyMarginEnd"/>
                                                                </HBox>
                                                                <Text
                                                                    text="SKU: {wizardModel>SKUID} • Marca: {wizardModel>MARCA} • CAT: {= ${wizardModel>CATEGORIAS}.join(', ') }"
                                                                    class="productLineSku"
                                                                    wrapping="false"/>
                                                            </VBox>
                                                        </HBox>
                                                    </HBox>
                                                </CustomListItem>
                                            </List>
                                        </VBox>
                                        
                                        <!-- SECCIÓN: PRODUCTOS DISPONIBLES - CON PAGINACIÓN -->
                                        <VBox>
                                            <List
                                                id="productosList"
                                                items="{wizardModel>/paginatedProducts}"
                                                width="100%"
                                                noDataText="No hay productos disponibles">
                                                
                                                <CustomListItem
                                                    type="Inactive"
                                                    class="productLineItem {= ${wizardModel>_selected} ? 'selectedLineItem' : '' }">
                                                    
                                                    <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%" class="productLineContent">
                                                        <HBox alignItems="Center" width="100%">
                                                            <CheckBox
                                                                selected="{wizardModel>_selected}"
                                                                select=".onProductSelect"
                                                                class="productLineCheckbox"/>
                                                            <VBox class="productLineInfo" width="100%">
                                                                <HBox>
                                                                    <Text
                                                                        text="{wizardModel>PRODUCTNAME}"
                                                                        class="productLineName"
                                                                        wrapping="false"/>
                                                                    <ToolbarSpacer/>
                                                                    <Text text="11/21/2025" class="sapUiTinyMarginStart sapUiTinyMarginEnd"/>
                                                                </HBox>
                                                                <Text
                                                                    text="SKU: {wizardModel>SKUID} • Marca: {wizardModel>MARCA} • CAT: {= ${wizardModel>CATEGORIAS}.join(', ') }"
                                                                    class="productLineSku"
                                                                    wrapping="false"/>
                                                            </VBox>
                                                        </HBox>
                                                    </HBox>
                                                </CustomListItem>
                                            </List>
                                            
                                            <!-- Botones de Paginación -->
                                            <HBox justifyContent="Center" alignItems="Center" class="sapUiSmallMarginTop" visible="{= ${wizardModel>/totalPages} > 1 }">
                                                <Button
                                                    icon="sap-icon://navigation-left-arrow"
                                                    press=".onPreviousPage"
                                                    enabled="{= ${wizardModel>/currentPage} > 1 }"
                                                    type="Transparent"/>
                                                <Text
                                                    text="Página {wizardModel>/currentPage} de {wizardModel>/totalPages}"
                                                    class="sapUiSmallMarginStart sapUiSmallMarginEnd"/>
                                                <Button
                                                    icon="sap-icon://navigation-right-arrow"
                                                    press=".onNextPage"
                                                    enabled="{= ${wizardModel>/currentPage} &lt; ${wizardModel>/totalPages} }"
                                                    type="Transparent"/>
                                            </HBox>
                                        </VBox>
                                        
                                        <MessageStrip
                                            text="Selecciona al menos un producto para continuar"
                                            type="Warning"
                                            showIcon="true"
                                            visible="{= ${wizardModel>/selectedProductsCount} === 0}"
                                            class="sapUiSmallMarginTop"/>
                                    </VBox>
                                </HBox>
                            </VBox>
                        </WizardStep>
                    </Wizard>
                    
                    <!-- Botones de navegación -->
                    <Bar class="sapUiSmallMarginTop">
                        <contentRight>
                            <Button
                                text="Anterior"
                                press=".onWizardBack"
                                visible="{path: 'wizardModel>/currentStep', formatter: '.formatVisibleBack'}"/>
                            <Button
                                text="Guardar"
                                type="Emphasized"
                                press=".onWizardNext"
                                enabled="{= ${wizardModel>/currentStep} === 1 ? ${wizardModel>/canProceed} : ${wizardModel>/buttonSaveEnabled} }"/>
                        </contentRight>
                    </Bar>
                    
                </VBox>
            </ScrollContainer>
        </content>
    </Page>
</mvc:View>
