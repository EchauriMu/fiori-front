<mvc:View
    controllerName="com.invertions.sapfiorimodinv.controller.listasprecios.CrearLista"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:l="sap.ui.layout"
    xmlns:core="sap.ui.core"
    height="100%">
    
    <Page
        id="crearListaPage"
        title="Crear Nueva Lista de Precios"
        showNavButton="true"
        navButtonPress=".onNavBack"
        class="sapUiResponsiveContentPadding">
        
        <content>
            <ScrollContainer height="100%" width="100%" vertical="true" horizontal="false">
                <VBox class="sapUiMediumMargin">
                    
                    <!-- Wizard con 2 pasos -->
                    <Wizard
                        id="wizardCrearLista"
                        complete=".onWizardComplete"
                        width="100%"
                        class="sapUiResponsiveMargin">
                        
                        <!-- PASO 1: Datos Generales -->
                        <WizardStep
                            id="step1Config"
                            title="Datos Generales"
                            validated="true">
                            
                            <VBox width="100%" alignItems="Center" class="sapUiSmallMargin">
                                <!-- Contenedor centrado del formulario -->
                                <VBox width="45em" class="sapUiSmallMargin">
                                    <Title text="Información General" level="H3" class="sapUiSmallMarginBottom"/>
                                    
                                    <Label text="Descripción de la Lista" required="true" class="sapUiTinyMarginTop"/>
                                    <Input
                                        id="inputDESLISTA"
                                        value="{wizardModel>/DESLISTA}"
                                        placeholder="Ej: Lista de Precios Retail 2025"
                                        required="true"
                                        change=".onValidateStep1"
                                        width="100%"
                                        maxLength="100"/>
                                    
                                    <Label text="Instituto" required="true" class="sapUiTinyMarginTop"/>
                                    <Input
                                        id="inputINSTITUTO"
                                        value="{wizardModel>/IDINSTITUTOOK}"
                                        placeholder="Ej: INST-001"
                                        required="true"
                                        change=".onValidateStep1"
                                        width="100%"
                                        maxLength="50"/>
                                    
                                    <Label text="Tipo de Lista" class="sapUiTinyMarginTop"/>
                                    <Select
                                        id="selectTipoLista"
                                        selectedKey="{wizardModel>/IDTIPOGENERALISTAOK}"
                                        change=".onTipoGeneralChange"
                                        width="100%">
                                        <items>
                                            <core:Item key="GENERAL" text="General"/>
                                            <core:Item key="ESPECIFICA" text="Específica"/>
                                        </items>
                                    </Select>
                                    
                                    <Label text="Tipo de Fórmula" class="sapUiTinyMarginTop"/>
                                    <Select
                                        id="selectTipoFormula"
                                        selectedKey="{wizardModel>/IDTIPOFORMULAOK}"
                                        change=".onTipoFormulaChange"
                                        width="100%">
                                        <items>
                                            <core:Item key="FIJO" text="Precio Fijo"/>
                                            <core:Item key="PORCENTAJE" text="Porcentaje"/>
                                            <core:Item key="FORMULA" text="Fórmula Personalizada"/>
                                        </items>
                                    </Select>
                                    
                                    <Title text="Vigencia" level="H3" class="sapUiSmallMarginTop"/>
                                    
                                    <Label text="Fecha Inicio" required="true" class="sapUiTinyMarginTop"/>
                                    <DatePicker
                                        id="dateInicio"
                                        value="{wizardModel>/FECHAEXPIRAINI}"
                                        displayFormat="dd/MM/yyyy"
                                        valueFormat="yyyy-MM-dd"
                                        change=".onValidateStep1"
                                        width="100%"/>
                                    
                                    <Label text="Fecha Fin" required="true" class="sapUiTinyMarginTop"/>
                                    <DatePicker
                                        id="dateFin"
                                        value="{wizardModel>/FECHAEXPIRAFIN}"
                                        displayFormat="dd/MM/yyyy"
                                        valueFormat="yyyy-MM-dd"
                                        change=".onValidateStep1"
                                        width="100%"/>
                                </VBox>
                            </VBox>
                        </WizardStep>
                        
                        <!-- PASO 2: Selección de Productos y Fórmula -->
                        <WizardStep
                            id="step2Filtros"
                            title="Selecciona los Productos"
                            validated="false">
                            
                            <VBox class="sapUiSmallMargin" height="100%">
                                <!-- Layout principal: 25% filtros, 75% tabla -->
                                <HBox width="100%" height="100%" alignItems="Stretch">
                                    
                                    <!-- COLUMNA IZQUIERDA: Filtros (25%) - COMPACTA -->
                                    <VBox width="25%" class="sapUiMediumMarginEnd" height="100%">
                                        <Title text="Filtros" level="H5" class="sapUiSmallMarginBottom"/>
                                        
                                        <!-- Búsqueda de Producto -->
                                        <VBox class="sapUiSmallMarginTop">
                                            <Label text="Buscar" class="sapUiTinyMarginBottom" width="100%"/>
                                            <SearchField
                                                id="searchProducto"
                                                value="{wizardModel>/searchTerm}"
                                                placeholder="SKU, nombre..."
                                                width="100%"
                                                search=".onSearchProduct"
                                                liveChange=".onSearchProduct"/>
                                        </VBox>
                                        
                                        <!-- Marcas (MultiComboBox) -->
                                        <VBox class="sapUiSmallMarginTop">
                                            <Label text="Marcas" class="sapUiTinyMarginBottom"/>
                                            <MultiComboBox
                                                id="comboMarcas"
                                                selectedKeys="{wizardModel>/selectedMarcas}"
                                                selectionChange=".onMarcasChange"
                                                width="100%"
                                                placeholder="Seleccionar..."
                                                items="{wizardModel>/availableMarcas}">
                                                <core:Item key="{wizardModel>name}" text="{wizardModel>name}"/>
                                            </MultiComboBox>
                                        </VBox>
                                        
                                        <!-- Categorías (MultiComboBox) -->
                                        <VBox class="sapUiSmallMarginTop">
                                            <Label text="Categorías" class="sapUiTinyMarginBottom"/>
                                            <MultiComboBox
                                                id="comboCategorias"
                                                selectedKeys="{wizardModel>/selectedCategories}"
                                                selectionChange=".onCategoriasChange"
                                                width="100%"
                                                placeholder="Seleccionar..."
                                                items="{wizardModel>/allCategories}">
                                                <core:Item key="{wizardModel>name}" text="{wizardModel>name}"/>
                                            </MultiComboBox>
                                        </VBox>
                                        
                                        <!-- Contador de filtros activos -->
                                        <HBox alignItems="Center" class="sapUiSmallMarginTop">
                                            <Label text="Filtros:" class="sapUiTinyMarginEnd"/>
                                            <ObjectNumber
                                                number="{wizardModel>/activeFilterCount}"
                                                state="Information"/>
                                            <ToolbarSpacer/>
                                            <Button
                                                icon="sap-icon://clear-filter"
                                                press=".onClearFilters"
                                                type="Transparent"
                                                width="40px"/>
                                        </HBox>
                                    </VBox>
                                    
                                    <!-- COLUMNA DERECHA: Productos (75%) - PAGINADA -->
                                    <VBox width="75%" class="sapUiSmallMarginTop" height="100%">
                                        <!-- Contador de seleccionados -->
                                        <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiSmallMarginBottom">
                                            <HBox alignItems="Center">
                                                <Label text="Seleccionados:" class="sapUiTinyMarginEnd"/>
                                                <ObjectNumber
                                                    number="{wizardModel>/selectedProductsCount}"
                                                    unit="de {= ${wizardModel>/allProducts}.length }"
                                                    state="Success"
                                                    emphasized="true"/>
                                            </HBox>
                                            <HBox alignItems="Center">
                                                <CheckBox
                                                    selected="{= ${wizardModel>/selectedProductsCount} > 0 &amp;&amp; ${wizardModel>/selectedProductsCount} === ${wizardModel>/availableProductsInList}.length }"
                                                    select=".onSelectAllProducts"/>
                                                <Label text="Todos" class="sapUiSmallMarginStart"/>
                                            </HBox>
                                        </HBox>
                                        
                                        <!-- SECCIÓN: PRODUCTOS SELECCIONADOS (PILA) - COMPACTA -->
                                        <VBox visible="{= ${wizardModel>/selectedProductsInPile}.length > 0 }" class="sapUiSmallMarginBottom">
                                            <Title text="Seleccionados ({= ${wizardModel>/selectedProductsInPile}.length })" level="H6" class="sapUiTinyMarginBottom"/>
                                            <List
                                                id="selectedProductsList"
                                                items="{wizardModel>/selectedProductsInPile}"
                                                width="100%"
                                                noDataText=""
                                                class="sapUiSmallMarginBottom">
                                                
                                                <CustomListItem
                                                    type="Inactive"
                                                    class="productLineItem selectedLineItem">
                                                    
                                                    <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%" class="productLineContent">
                                                        <HBox alignItems="Center" width="100%">
                                                            <CheckBox
                                                                selected="{wizardModel>_selected}"
                                                                select=".onProductSelect"
                                                                class="productLineCheckbox"/>
                                                            <VBox class="productLineInfo" width="100%">
                                                                <Text
                                                                    text="{wizardModel>PRODUCTNAME}"
                                                                    class="productLineName"
                                                                    wrapping="false"/>
                                                                <Text
                                                                    text="SKU: {wizardModel>SKUID}"
                                                                    class="productLineSku"
                                                                    wrapping="false"/>
                                                            </VBox>
                                                        </HBox>
                                                        <core:Icon
                                                            src="sap-icon://accept"
                                                            color="#4CAF50"
                                                            class="productLineIcon"/>
                                                    </HBox>
                                                </CustomListItem>
                                            </List>
                                        </VBox>
                                        
                                        <!-- SECCIÓN: PRODUCTOS DISPONIBLES - CON PAGINACIÓN -->
                                        <VBox>
                                            <Title text="Disponibles ({= ${wizardModel>/availableProductsInList}.length })" level="H6" class="sapUiTinyMarginBottom" visible="{= ${wizardModel>/availableProductsInList}.length > 0 }"/>
                                            <List
                                                id="productosList"
                                                items="{wizardModel>/paginatedProducts}"
                                                width="100%"
                                                noDataText="No hay productos disponibles">
                                                
                                                <CustomListItem
                                                    type="Inactive"
                                                    class="productLineItem {= ${wizardModel>_selected} ? 'selectedLineItem' : '' }">
                                                    
                                                    <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%" class="productLineContent">
                                                        <HBox alignItems="Center" width="100%">
                                                            <CheckBox
                                                                selected="{wizardModel>_selected}"
                                                                select=".onProductSelect"
                                                                class="productLineCheckbox"/>
                                                            <VBox class="productLineInfo" width="100%">
                                                                <Text
                                                                    text="{wizardModel>PRODUCTNAME}"
                                                                    class="productLineName"
                                                                    wrapping="false"/>
                                                                <Text
                                                                    text="SKU: {wizardModel>SKUID}"
                                                                    class="productLineSku"
                                                                    wrapping="false"/>
                                                            </VBox>
                                                        </HBox>
                                                        <core:Icon
                                                            src="sap-icon://navigation-right-arrow"
                                                            class="productLineIcon"/>
                                                    </HBox>
                                                </CustomListItem>
                                            </List>
                                            
                                            <!-- Botones de Paginación -->
                                            <HBox justifyContent="Center" alignItems="Center" class="sapUiSmallMarginTop" visible="{= ${wizardModel>/totalPages} > 1 }">
                                                <Button
                                                    icon="sap-icon://navigation-left-arrow"
                                                    press=".onPreviousPage"
                                                    enabled="{= ${wizardModel>/currentPage} > 1 }"
                                                    type="Transparent"/>
                                                <Text
                                                    text="Página {wizardModel>/currentPage} de {wizardModel>/totalPages}"
                                                    class="sapUiSmallMarginStart sapUiSmallMarginEnd"/>
                                                <Button
                                                    icon="sap-icon://navigation-right-arrow"
                                                    press=".onNextPage"
                                                    enabled="{= ${wizardModel>/currentPage} &lt; ${wizardModel>/totalPages} }"
                                                    type="Transparent"/>
                                            </HBox>
                                        </VBox>
                                        
                                        <MessageStrip
                                            text="Selecciona al menos un producto para continuar"
                                            type="Warning"
                                            showIcon="true"
                                            visible="{= ${wizardModel>/selectedProductsCount} === 0}"
                                            class="sapUiSmallMarginTop"/>
                                    </VBox>
                                </HBox>
                            </VBox>
                        </WizardStep>
                    </Wizard>
                    
                    <!-- Botones de navegación -->
                    <Bar class="sapUiSmallMarginTop">
                        <contentRight>
                            <Button
                                text="Anterior"
                                press=".onWizardBack"
                                visible="{= ${wizardModel>/currentStep} > 1}"/>
                            <Button
                                text="{= ${wizardModel>/currentStep} === 2 ? 'Guardar' : 'Siguiente'}"
                                type="Emphasized"
                                press=".onWizardNext"
                                enabled="{= ${wizardModel>/currentStep} === 1 ? ${wizardModel>/canProceed} : ${wizardModel>/selectedProductsCount} > 0 }"/>
                        </contentRight>
                    </Bar>
                    
                </VBox>
            </ScrollContainer>
        </content>
    </Page>
</mvc:View>
