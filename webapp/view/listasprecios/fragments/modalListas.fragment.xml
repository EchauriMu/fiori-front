<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.ui.layout.form"
    xmlns:mvc="sap.ui.core.mvc"
>
    <Dialog
        id="idListaDetailDialog"
        title="{= ${detailView>/editableLista} ? 'Editar Lista de Precios' : (${detailView>/IDLISTAOK} ? 'Detalle de Lista' : 'Nueva Lista de Precios')}"
        type="Standard"
        class="sapUiSmallMargin"
        contentHeight="80vh"
        contentWidth="45vw"
        resizable="true"
        draggable="true"
    >
        <!-- Contenido principal -->
        <content>
            <ScrollContainer height="100%" width="100%">
                <VBox class="sapUiSmallMargin">
                    <!-- Sección de Información General -->
                    <Panel 
                        headerText="Información General" 
                        class="sapUiSmallMargin"
                        expandable="true"
                        expanded="true"
                    >
                        <content>
                            <f:SimpleForm editable="true" layout="ResponsiveGridLayout" class="sapUiSmallMargin">
                                <f:content>
                                    <!-- ID Lista (solo lectura) -->
                                    <Label text="ID Lista"/>
                                    <Text text="{detailView>/IDLISTAOK}" class="sapUiForceMonospace sapUiForceBold"/>

                                    <!-- Estado (ObjectStatus) -->
                                    <Label text="Estado"/>
                                    <ObjectStatus
                                        state="{
                                            path: 'detailView>/ACTIVED,detailView>/DELETED',
                                            formatter: '.formatterListaStatus'
                                        }"
                                        text="{
                                            path: 'detailView>/ACTIVED,detailView>/DELETED',
                                            formatter: '.formatterListaStatusText'
                                        }"
                                    />

                                    <!-- Descripción de la lista -->
                                    <Label text="Descripción"/>
                                    <Input
                                        value="{path: 'detailView>/editableLista/DESLISTA'}"
                                        enabled="{detailView>/editing}"
                                        placeholder="Ej: Lista de precios Verano 2024"
                                    />

                                    <!-- Instituto -->
                                    <Label text="Instituto"/>
                                    <Input
                                        value="{path: 'detailView>/editableLista/IDINSTITUTOOK'}"
                                        enabled="{detailView>/editing}"
                                        placeholder="Ej: INSTITUTO-XYZ"
                                    />

                                    <!-- Tipo Lista -->
                                    <Label text="Tipo de Lista"/>
                                    <Input
                                        value="{path: 'detailView>/editableLista/IDTIPOLISTAOK'}"
                                        enabled="{detailView>/editing}"
                                        placeholder="Ej: TIPO-01"
                                    />

                                    <!-- Tipo General -->
                                    <Label text="Tipo General"/>
                                    <Select
                                        selectedKey="{path: 'detailView>/editableLista/IDTIPOGENERALISTAOK'}"
                                        enabled="{detailView>/editing}"
                                        autoAdjustWidth="true"
                                    >
                                        <core:Item key="ESPECIFICA" text="Específica"/>
                                        <core:Item key="GENERAL" text="General"/>
                                    </Select>

                                    <!-- Tipo Fórmula -->
                                    <Label text="Tipo de Fórmula"/>
                                    <Select
                                        selectedKey="{path: 'detailView>/editableLista/IDTIPOFORMULAOK'}"
                                        enabled="{detailView>/editing}"
                                        autoAdjustWidth="true"
                                    >
                                        <core:Item key="FIJO" text="Fijo"/>
                                        <core:Item key="VARIABLE" text="Variable"/>
                                        <core:Item key="DESCUENTO" text="Descuento"/>
                                    </Select>

                                    <!-- ID Lista BK (BackKlassify) -->
                                    <Label text="ID Lista BackEnd"/>
                                    <Input
                                        value="{path: 'detailView>/editableLista/IDLISTABK'}"
                                        enabled="{detailView>/editing}"
                                        placeholder="Campo de referencia"
                                    />
                                </f:content>
                            </f:SimpleForm>
                        </content>
                    </Panel>

                    <!-- Sección de SKUs Asociados -->
                    <Panel 
                        headerText="SKUs Asociados" 
                        class="sapUiSmallMargin"
                        expandable="true"
                        expanded="true"
                    >
                        <content>
                            <VBox class="sapUiSmallMargin">
                                <Label text="Selecciona uno o más SKUs" class="sapUiSmallMarginBottom"/>
                                
                                <!-- MultiComboBox para seleccionar SKUs -->
                                <MultiComboBox
                                    id="skuMultiCombo"
                                    items="{detailView>/availableProducts}"
                                    selectedKeys="{path: 'detailView>/editableLista/SKUSIDS'}"
                                    selectionChange=".onSKUSIDsChange"
                                    enabled="{detailView>/editing}"
                                    width="100%"
                                    placeholder="Selecciona SKUs..."
                                    class="sapUiSmallMarginBottom"
                                >
                                    <core:Item key="{detailView>SKUID}" text="{detailView>PRODUCTNAME}"/>
                                </MultiComboBox>

                                <!-- SKUs Seleccionados: Mostrar el primero + contador -->
                                <VBox 
                                    visible="{= ${detailView>/editableLista/SKUSIDS}.length > 0 }"
                                    class="sapUiSmallMarginTop"
                                >
                                    <HBox alignItems="Center" class="sapUiSmallMarginBottom">
                                        <Token 
                                            text="{path: 'detailView>/editableLista/SKUSIDS', formatter: '.formatterFirstSKU'}"
                                            tooltip="{path: 'detailView>/editableLista/SKUSIDS', formatter: '.formatterAllSKUs'}"
                                        />
                                        <Text 
                                            text="{path: 'detailView>/editableLista/SKUSIDS', formatter: '.formatterSKUCount'}"
                                            class="sapUiSmallMarginStart sapUiSmallText"
                                        />
                                    </HBox>
                                </VBox>
                                
                                <Text 
                                    text="Sin SKUs seleccionados"
                                    visible="{= ${detailView>/editableLista/SKUSIDS}.length === 0 }"
                                    class="sapUiSmallMarginTop sapUiTinyText"
                                />
                            </VBox>
                        </content>
                    </Panel>

                    <!-- Sección de Vigencia -->
                    <Panel 
                        headerText="Configuración de Vigencia" 
                        class="sapUiSmallMargin"
                        expandable="true"
                        expanded="true"
                    >
                        <content>
                            <f:SimpleForm editable="true" layout="ResponsiveGridLayout" class="sapUiSmallMargin">
                                <f:content>
                                    <!-- Inicio de Vigencia -->
                                    <Label text="Inicio de Vigencia"/>
                                    <DatePicker
                                        value="{path: 'detailView>/editableLista/FECHAEXPIRAINI'}"
                                        enabled="{detailView>/editing}"
                                        displayFormat="dd/MM/yyyy"
                                    />

                                    <!-- Fin de Vigencia -->
                                    <Label text="Fin de Vigencia"/>
                                    <DatePicker
                                        value="{path: 'detailView>/editableLista/FECHAEXPIRAFIN'}"
                                        enabled="{detailView>/editing}"
                                        displayFormat="dd/MM/yyyy"
                                    />
                                </f:content>
                            </f:SimpleForm>
                        </content>
                    </Panel>

                    <!-- Sección de Auditoría -->
                    <Panel 
                        headerText="Auditoría" 
                        class="sapUiSmallMargin"
                        expandable="true"
                        expanded="false"
                    >
                        <content>
                            <f:SimpleForm layout="ResponsiveGridLayout" class="sapUiSmallMargin">
                                <f:content>
                                    <!-- Creado por -->
                                    <Label text="Creado por"/>
                                    <Text text="{detailView>/REGUSER}"/>

                                    <!-- Fecha Creación -->
                                    <Label text="Fecha Creación"/>
                                    <Text 
                                        text="{
                                            path: 'detailView>/REGDATE',
                                            formatter: '.formatterDate'
                                        }"
                                    />

                                    <!-- Modificado por -->
                                    <Label text="Modificado por"/>
                                    <Text text="{detailView>/MODUSER}"/>

                                    <!-- Fecha Modificación -->
                                    <Label text="Fecha Modificación"/>
                                    <Text 
                                        text="{
                                            path: 'detailView>/MODDATE',
                                            formatter: '.formatterDate'
                                        }"
                                    />
                                </f:content>
                            </f:SimpleForm>
                        </content>
                    </Panel>

                    <!-- Sección de Productos con Presentaciones (solo en modo detalle, no edición) -->
                    <Panel 
                        headerText="Productos Registrados en esta Lista" 
                        class="sapUiSmallMargin"
                        expandable="true"
                        expanded="false"
                        visible="{= !${detailView>/editing} &amp;&amp; !!${detailView>/IDLISTAOK}}"
                    >
                        <content>
                            <VBox class="sapUiSmallMargin">
                                <!-- Buscador -->
                                <HBox alignItems="Center" class="sapUiSmallMarginBottom">
                                    <SearchField 
                                        placeholder="Buscar por producto..."
                                        value="{detailView>/searchSKU}"
                                        width="250px"
                                    />
                                    <Text 
                                        text="{= 'Total: ' + ${detailView>/SKUSIDS/length}}"
                                        class="sapUiForceBold sapUiSmallMarginStart"
                                    />
                                </HBox>

                                <!-- Loading -->
                                <VBox 
                                    visible="{detailView>/loadingProductos}"
                                    alignItems="Center"
                                    justifyContent="Center"
                                    height="150px"
                                >
                                    <BusyIndicator busy="true"/>
                                </VBox>

                                <!-- Error Message -->
                                <MessageStrip
                                    text="{detailView>/errorProductos}"
                                    type="Error"
                                    showCloseButton="false"
                                    visible="{= !!${detailView>/errorProductos}}"
                                    class="sapUiSmallMarginBottom"
                                />

                                <!-- Lista de Productos -->
                                <List 
                                    items="{detailView>/productosLista}"
                                    visible="{= ${detailView>/productosLista}.length > 0}"
                                >
                                    <CustomListItem>
                                        <VBox width="100%">
                                            <Panel
                                                expandable="true"
                                                expanded="false"
                                                headerText="{SKUID} - {PRODUCTNAME}"
                                                width="100%"
                                                class="sapUiSmallMarginBottom"
                                            >
                                                <content>
                                                    <!-- Info Producto -->
                                                    <f:SimpleForm layout="ResponsiveGridLayout" editable="false" class="sapUiSmallMarginBottom">
                                                        <f:content>
                                                            <Label text="SKU"/>
                                                            <Text text="{SKUID}"/>

                                                            <Label text="Producto"/>
                                                            <Text text="{PRODUCTNAME}"/>

                                                            <Label text="Marca"/>
                                                            <Text text="{MARCA}"/>
                                                        </f:content>
                                                    </f:SimpleForm>

                                                    <!-- Panel de Imágenes -->
                                                    <Panel 
                                                        headerText="Imágenes del Producto"
                                                        expandable="true"
                                                        expanded="false"
                                                        width="100%"
                                                        class="sapUiSmallMarginTop"
                                                        visible="{= ${imageFiles} &amp;&amp; ${imageFiles}.length > 0}"
                                                    >
                                                        <content>
                                                            <VBox alignItems="Center" justifyContent="Center" class="sapUiSmallMargin">
                                                                <!-- Carousel de imágenes si hay múltiples -->
                                                                <VBox visible="{= ${imageFiles} &amp;&amp; ${imageFiles}.length > 1}" width="100%">
                                                                    <Carousel 
                                                                        pages="{imageFiles}"
                                                                        pageIndicatorPlacement="Bottom"
                                                                        width="100%"
                                                                    >
                                                                        <Image 
                                                                            src="{FILEURL}"
                                                                            width="300px"
                                                                            height="300px"
                                                                            densityAware="false"/>
                                                                    </Carousel>
                                                                </VBox>

                                                                <!-- Imagen simple si solo hay una -->
                                                                <VBox visible="{= ${imageFiles} &amp;&amp; ${imageFiles}.length === 1}" alignItems="Center" justifyContent="Center">
                                                                    <Image 
                                                                        src="{imageFiles/0/FILEURL}"
                                                                        width="300px"
                                                                        height="300px"
                                                                        densityAware="false"/>
                                                                </VBox>
                                                            </VBox>
                                                        </content>
                                                    </Panel>

                                                    <!-- Presentaciones -->
                                                    <Panel 
                                                        headerText="Presentaciones"
                                                        expandable="true"
                                                        expanded="true"
                                                        width="100%"
                                                        class="sapUiSmallMarginTop"
                                                    >
                                                        <content>
                                                            <List items="{presentaciones}">
                                                                <StandardListItem
                                                                    title="{IdPresentaOK}"
                                                                    description="{Presentacion}"
                                                                />
                                                            </List>
                                                            <MessageStrip
                                                                text="Sin presentaciones"
                                                                type="Information"
                                                                showCloseButton="false"
                                                                visible="{= !${presentaciones} || (Array.isArray(${presentaciones}) &amp;&amp; ${presentaciones}.length === 0)}"
                                                            />
                                                        </content>
                                                    </Panel>
                                                </content>
                                            </Panel>
                                        </VBox>
                                    </CustomListItem>
                                </List>

                                <!-- Sin productos -->
                                <MessageStrip
                                    text="No hay productos registrados en esta lista. Haz clic en 'Editar' para agregar SKUs."
                                    type="Information"
                                    showCloseButton="false"
                                    visible="{= ${detailView>/productosLista}.length === 0 &amp;&amp; !${detailView>/loadingProductos}}"
                                />
                            </VBox>
                        </content>
                    </Panel>

                    <!-- Sección de Control de Estado (solo en modo detalle, no edición) -->
                    <Panel 
                        headerText="Control de Estado" 
                        class="sapUiSmallMargin"
                        expandable="true"
                        expanded="false"
                        visible="{= !${detailView>/editing} &amp;&amp; !!${detailView>/IDLISTAOK}}"
                    >
                        <content>
                            <VBox class="sapUiSmallMargin">
                                <HBox class="sapUiSmallMargin">
                                    <Label text="Lista Activa"/>
                                    <Switch
                                        state="{detailView>/ACTIVED}"
                                        change=".onToggleListaStatus"
                                        enabled="{= !${detailView>/saving}}"
                                    />
                                </HBox>
                                <Text 
                                    text="{= ${detailView>/ACTIVED} ? 'Esta lista está activa' : 'Esta lista está inactiva'}"
                                    class="sapUiSmallText"
                                />
                            </VBox>
                        </content>
                    </Panel>
                </VBox>
            </ScrollContainer>
        </content>

        <!-- Footer con botones -->
        <beginButton>
            <Button
                id="idListaSaveButton"
                text="{= ${detailView>/editing} ? 'Guardar' : 'Editar'}"
                type="{= ${detailView>/editing} ? 'Emphasized' : 'Default'}"
                press=".onListaButtonPress"
                enabled="{= !${detailView>/saving}}"
            />
        </beginButton>

        <endButton>
            <Button
                id="idListaCancelButton"
                text="{= ${detailView>/editing} ? 'Cancelar' : (!!${detailView>/IDLISTAOK} ? 'Cerrar' : 'Cancelar')}"
                press=".onListaCancelPress"
            />
        </endButton>
    </Dialog>
</core:FragmentDefinition>