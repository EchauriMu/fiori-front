<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.ui.layout.form"
>
    <Dialog
        id="idProductosListaModalDialog"
        title="Productos Registrados en esta Lista"
        type="Standard"
        contentWidth="1200px"
        contentHeight="95vh"
        resizable="true"
        draggable="true"
    >
        <content>
            <ScrollContainer height="100%" width="100%" vertical="true" horizontal="false">
                <VBox class="sapUiLargeMargin" width="100%">
                    
                    <!-- Encabezado -->
                    <Title level="H2" text="{detailView>/DESLISTA}" class="sapUiForceBold sapUiSmallMarginBottom"/>
                    
                    <!-- Buscador y Contador -->
                    <HBox alignItems="Center" class="sapUiSmallMarginBottom">
                        <SearchField 
                            id="idSearchProductos"
                            placeholder="Buscar por producto o SKU..."
                            value="{detailView>/searchSKU}"
                            liveChange=".onSearchProductos"
                            width="400px"
                        />
                        <Text 
                            text="{= 'Total de SKUs: ' + ${detailView>/SKUSIDS/length}}" 
                            class="sapUiSmallMarginStart sapUiForceBold"
                        />
                    </HBox>

                    <!-- Loading -->
                    <VBox 
                        visible="{detailView>/loadingProductos}"
                        alignItems="Center"
                        justifyContent="Center"
                        height="300px"
                    >
                        <BusyIndicator busy="true"/>
                        <Text text="Cargando productos..." class="sapUiSmallMarginTop sapUiGreyText"/>
                    </VBox>

                    <!-- Error Message -->
                    <MessageStrip
                        text="{detailView>/errorProductos}"
                        type="Error"
                        showCloseButton="false"
                        visible="{= !!${detailView>/errorProductos}}"
                        class="sapUiSmallMarginBottom"
                    />

                    <!-- Lista de Productos con Panels Expandibles -->
                    <VBox class="sapUiSmallMargin">
                        <List id="idProductosList" items="{detailView>/productosListaFiltered}">
                            <CustomListItem type="Inactive">
                                <VBox width="100%" class="sapUiSmallMarginBottom">
                                    <!-- Panel Expandible para cada Producto -->
                                    <Panel
                                        expandable="true"
                                        expanded="false"
                                        headerText="{detailView>SKUID} - {detailView>PRODUCTNAME}"
                                        width="100%"
                                    >
                                        <content>
                                            <VBox class="sapUiSmallMargin">
                                                <!-- Panel de Imágenes Expandible con Carousel -->
                                                <Panel 
                                                    headerText="Imágenes"
                                                    expandable="true"
                                                    expanded="false"
                                                    width="100%"
                                                    class="sapUiSmallMarginBottom"
                                                >
                                                    <content>
                                                        <VBox class="sapUiSmallMargin">
                                                            <!-- Carousel si hay imágenes cargadas -->
                                                            <VBox visible="{= ${detailView>imageFiles} &amp;&amp; ${detailView>imageFiles}.length > 0}">
                                                                <Carousel
                                                                    class="sapUiSmallMarginTop"
                                                                    height="220px"
                                                                    pages="{path: 'detailView>imageFiles'}">
                                                                    <Image
                                                                        src="{detailView>FILE}"
                                                                        alt="{detailView>INFOAD}"
                                                                        densityAware="false"
                                                                        width="170px"
                                                                        height="150px"/>
                                                                </Carousel>
                                                            </VBox>

                                                            <!-- Fallback imagen simple si no hay carousel -->
                                                            <VBox alignItems="Center" justifyContent="Center" visible="{= !${detailView>imageFiles} || ${detailView>imageFiles}.length === 0}">
                                                                <Image 
                                                                    src="{detailView>FOTOPRODUCTO}"
                                                                    width="300px"
                                                                    height="300px"
                                                                    densityAware="false"
                                                                    visible="{= !!${detailView>FOTOPRODUCTO}}"
                                                                />
                                                            </VBox>
                                                        </VBox>
                                                    </content>
                                                </Panel>

                                                <!-- Presentaciones Panel -->
                                                <Panel 
                                                    headerText="{= 'Presentaciones (' + (${detailView>presentaciones} &amp;&amp; ${detailView>presentaciones}.length ? ${detailView>presentaciones}.length : 0) + ')'}"
                                                    expandable="true"
                                                    expanded="false"
                                                    width="100%"
                                                >
                                                    <content>
                                                        <VBox>
                                                            <!-- Lista de Presentaciones -->
                                                            <VBox visible="{= ${detailView>presentaciones} &amp;&amp; ${detailView>presentaciones}.length > 0}">
                                                                <List items="{detailView>presentaciones}">
                                                                                    <CustomListItem type="Inactive">
                                                                        <VBox width="100%">
                                                                            <!-- Panel Expandible para cada Presentación -->
                                                                            <Panel
                                                                                expandable="true"
                                                                                expanded="false"
                                                                                headerText="{detailView>NOMBREPRESENTACION}"
                                                                                width="100%"
                                                                            >
                                                                                <content>
                                                                                    <VBox class="sapUiSmallMargin">
                                                                                        <!-- Info General de Presentación -->
                                                                                        <f:SimpleForm layout="ResponsiveGridLayout" editable="false" class="sapUiSmallMarginBottom">
                                                                                            <f:content>
                                                                                                <Label text="Código Presentación"/>
                                                                                                <Text text="{detailView>IdPresentaOK}" class="sapUiForceBold"/>

                                                                                                <Label text="Nombre"/>
                                                                                                <Text text="{detailView>NOMBREPRESENTACION}"/>

                                                                                                <Label text="Descripción"/>
                                                                                                <Text text="{detailView>Descripcion}"/>

                                                                                                <Label text="Código de Barras"/>
                                                                                                <Text text="{detailView>BARCODE}"/>

                                                                                                <Label text="Costo Inicial"/>
                                                                                                <Text text="{detailView>CostoIni}"/>

                                                                                                <Label text="Costo Final"/>
                                                                                                <Text text="{detailView>CostoFin}"/>

                                                                                                <Label text="Registrado por"/>
                                                                                                <Text text="{detailView>REGUSER}"/>

                                                                                                <Label text="Fecha Registro"/>
                                                                                                <Text text="{detailView>REGDATE}"/>

                                                                                                <Label text="Estado"/>
                                                                                                <VBox>
                                                                                                    <ObjectStatus 
                                                                                                        state="{= ${detailView>ACTIVED} ? 'Success' : 'Error' }"
                                                                                                        text="{= ${detailView>ACTIVED} ? 'Activo' : 'Inactivo' }"
                                                                                                    />
                                                                                                </VBox>
                                                                                            </f:content>
                                                                                        </f:SimpleForm>

                                                                                        <!-- Imagen de Presentación (si existe) -->
                                                                                        <Panel 
                                                                                            headerText="Imágenes"
                                                                                            expandable="true"
                                                                                            expanded="false"
                                                                                            width="100%"
                                                                                            visible="{= !!${detailView>FOTOPRODUCTO}}"
                                                                                            class="sapUiSmallMarginBottom"
                                                                                        >
                                                                                            <content>
                                                                                                <VBox alignItems="Center" justifyContent="Center" class="sapUiSmallMargin">
                                                                                                    <Image 
                                                                                                        src="{detailView>FOTOPRODUCTO}"
                                                                                                        width="250px"
                                                                                                        height="250px"
                                                                                                        densityAware="false"
                                                                                                    />
                                                                                                </VBox>
                                                                                            </content>
                                                                                        </Panel>
                                                                                    </VBox>
                                                                                </content>
                                                                            </Panel>
                                                                        </VBox>
                                                                    </CustomListItem>
                                                                </List>
                                                            </VBox>
                                                            <!-- Sin presentaciones -->
                                                            <MessageStrip text="Sin presentaciones registradas" type="Information" showCloseButton="false" visible="{= !${detailView>presentaciones} || ${detailView>presentaciones}.length === 0}"/>
                                                        </VBox>
                                                    </content>
                                                </Panel>
                                            </VBox>
                                        </content>
                                    </Panel>
                                </VBox>
                            </CustomListItem>
                        </List>
                    </VBox>

                    <!-- Sin productos -->
                    <MessageStrip
                        text="No hay productos registrados en esta lista"
                        type="Information"
                        showCloseButton="false"
                        visible="{= !${detailView>/productosLista} || ${detailView>/productosLista}.length === 0}"
                    />

                </VBox>
            </ScrollContainer>
        </content>

        <beginButton>
            <Button
                text="Guardar Precios"
                type="Emphasized"
                enabled="{= !${detailView>/saving}}"
                press=".onGuardarPrecios"
            />
        </beginButton>

        <endButton>
            <Button
                text="Cerrar"
                press=".onCloseProductosDialog"
            />
        </endButton>
    </Dialog>
</core:FragmentDefinition>
