<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.ui.layout.form"
>
    <Dialog
        id="addProductsFilterDialog"
        title="Seleccionar Productos y Presentaciones"
        contentWidth="95%"
        contentHeight="90%"
        resizable="true"
        draggable="true"
        afterClose="onCloseFilterDialog"
    >
        <content>
            <VBox width="100%">
                
                <MessageStrip
                    text="Seleccione los productos y presentaciones que desea agregar a esta promoción. Use los filtros para facilitar la búsqueda."
                    type="Information"
                    showIcon="true"
                    class="sapUiSmallMarginBottom"
                />
                
                <!-- Panel de Filtros -->
                <Panel 
                    headerText="Filtros de Búsqueda" 
                    expandable="true" 
                    expanded="true"
                    class="sapUiSmallMarginBottom"
                    width="100%"
                >
                    <content>
                        <VBox width="100%">
                            <f:SimpleForm
                                editable="true"
                                layout="ResponsiveGridLayout"
                                columnsL="3"
                                columnsM="2"
                                width="100%"
                            >
                                <f:content>
                                    <Label text="Buscar Producto" />
                                    <SearchField
                                        placeholder="Nombre, SKU, marca..."
                                        value="{filterModel>/searchTerm}"
                                        search="onFilterSearch"
                                        width="100%"
                                    />

                                    <Label text="Categoría" />
                                    <MultiComboBox
                                        id="categoriesFilter"
                                        placeholder="Seleccionar categorías..."
                                        items="{filterModel>/allCategories}"
                                        selectedKeys="{filterModel>/filters/categorias}"
                                        selectionChange="onFilterCategoryChange"
                                        width="100%"
                                    >
                                        <core:Item key="{filterModel>CATID}" text="{filterModel>Nombre}" />
                                    </MultiComboBox>

                                    <Label text="Marca" />
                                    <MultiComboBox
                                        id="brandsFilter"
                                        placeholder="Seleccionar marcas..."
                                        items="{filterModel>/allBrands}"
                                        selectedKeys="{filterModel>/filters/marcas}"
                                        selectionChange="onFilterBrandChange"
                                        width="100%"
                                    >
                                        <core:Item key="{filterModel>id}" text="{filterModel>name}" />
                                    </MultiComboBox>
                                </f:content>
                            </f:SimpleForm>
                            <Toolbar width="100%">
                                <ToolbarSpacer />
                                <Button 
                                    text="Limpiar Filtros" 
                                    press="onClearFilters"
                                    icon="sap-icon://clear-filter"
                                />
                            </Toolbar>
                        </VBox>
                    </content>
                </Panel>

                <!-- Panel de Productos -->
                <Panel 
                    headerText="Productos Disponibles ({filterModel>/filteredProductsCount})" 
                    class="sapUiSmallMarginBottom"
                >
                    <headerToolbar>
                        <OverflowToolbar>
                            <Title text="Productos Disponibles ({filterModel>/filteredProductsCount})" level="H5" />
                            <ToolbarSpacer />
                            <Text text="{filterModel>/selectedPresentacionesCount} presentación(es) seleccionada(s)" />
                            <Button 
                                text="Seleccionar Todos" 
                                press="onSelectAllProducts"
                                type="Transparent"
                            />
                            <Button 
                                text="Deseleccionar Todos" 
                                press="onClearSelection"
                                type="Transparent"
                            />
                        </OverflowToolbar>
                    </headerToolbar>
                    <content>
                        <!-- Loading -->
                        <FlexBox
                            visible="{filterModel>/loading}"
                            justifyContent="Center"
                            alignItems="Center"
                            class="sapUiMediumMargin"
                        >
                            <BusyIndicator size="5rem" />
                        </FlexBox>

                        <!-- Lista de productos -->
                        <List
                            items="{filterModel>/paginatedProducts}"
                            mode="None"
                            noDataText="Aplica filtros para ver productos específicos"
                            visible="{= !${filterModel>/loading} }"
                        >
                            <CustomListItem>
                                <VBox class="sapUiSmallMargin" width="100%">
                                    <!-- PRODUCTO CON CHECKBOX -->
                                    <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%" class="productHeader sapUiSmallPadding">
                                        <HBox alignItems="Center" width="50%">
                                            <CheckBox
                                                selected="{filterModel>allSelected}"
                                                select="onFilterProductCheckBoxSelect"
                                                class="sapUiTinyMarginEnd"
                                            />
                                            <VBox width="100%">
                                                <Title level="H6" text="{filterModel>PRODUCTNAME}" />
                                                <Text text="SKU: {filterModel>SKUID} | Marca: {filterModel>MARCA}" />
                                            </VBox>
                                        </HBox>
                                        <HBox alignItems="Center" width="50%" justifyContent="End">
                                            <Text text="{= ${filterModel>presentaciones}.length || 0 } presentación(es)" class="sapUiTinyMarginEnd"/>
                                            <Button
                                                type="Transparent"
                                                press="onFilterToggleProduct"
                                                icon="{= ${filterModel>expanded} ? 'sap-icon://collapse' : 'sap-icon://expand' }"
                                                tooltip="{= ${filterModel>expanded} ? 'Ocultar presentaciones' : 'Mostrar presentaciones' }"
                                            />
                                        </HBox>
                                    </HBox>

                                    <!-- PRESENTACIONES CON INDENTACIÓN -->
                                    <VBox visible="{= ${filterModel>expanded} === true }" class="presentacionesContainer">
                                        
                                        <!-- Loading indicator para presentaciones -->
                                        <FlexBox
                                            visible="{filterModel>loadingPresentaciones}"
                                            justifyContent="Center"
                                            alignItems="Center"
                                            class="sapUiSmallMarginTopBottom"
                                        >
                                            <BusyIndicator size="2rem" class="sapUiTinyMarginEnd" />
                                            <Text text="Cargando presentaciones..." class="sapUiTinyText" />
                                        </FlexBox>
                                        
                                        <!-- Lista de presentaciones -->
                                        <List
                                            items="{filterModel>presentaciones}"
                                            mode="None"
                                            showSeparators="Inner"
                                            visible="{= !${filterModel>loadingPresentaciones} }"
                                        >
                                            <CustomListItem>
                                                <HBox alignItems="Center" justifyContent="SpaceBetween" width="100%" class="sapUiSmallPadding sapUiMediumMarginBegin">
                                                    <HBox alignItems="Center" width="60%">
                                                        <CheckBox 
                                                            selected="{filterModel>selected}"
                                                            enabled="{= !${filterModel>locked} }"
                                                            select="onFilterPresentacionSelect"
                                                            class="sapUiTinyMarginEnd"
                                                        />
                                                        <VBox width="90%">
                                                            <HBox alignItems="Center">
                                                                <Text text="{filterModel>NOMBREPRESENTACION}" class="sapUiTextBold"/>
                                                                <ObjectStatus
                                                                    text="Ya en promoción"
                                                                    state="Information"
                                                                    visible="{filterModel>locked}"
                                                                    class="sapUiTinyMarginStart"
                                                                />
                                                            </HBox>
                                                            <Text text="ID: {filterModel>IdPresentaOK}" class="sapUiTinyText"/>
                                                        </VBox>
                                                    </HBox>
                                                    <HBox width="40%" justifyContent="End" class="sapUiTinyMarginEnd">
                                                        <ObjectStatus
                                                            text="${filterModel>PRECIO}"
                                                            state="Success"
                                                        />
                                                    </HBox>
                                                </HBox>
                                            </CustomListItem>
                                        </List>
                                    </VBox>
                                </VBox>
                            </CustomListItem>
                        </List>
                        
                        <!-- Controles de Paginación -->
                        <Toolbar visible="{= !${filterModel>/loading} }">
                            <ToolbarSpacer />
                            <Label text="Productos por página:" />
                            <Select
                                selectedKey="{filterModel>/pagination/itemsPerPage}"
                                change="onFilterPageSizeChange"
                                width="80px"
                            >
                                <core:Item key="5" text="5" />
                                <core:Item key="10" text="10" />
                                <core:Item key="20" text="20" />
                                <core:Item key="50" text="50" />
                            </Select>
                            <ToolbarSpacer />
                            <Button
                                icon="sap-icon://navigation-left-arrow"
                                press="onFilterPreviousPage"
                                enabled="{= ${filterModel>/pagination/currentPage} > 1 }"
                                type="Transparent"
                            />
                            <Text text="Página {filterModel>/pagination/currentPage} de {filterModel>/pagination/totalPages}" class="sapUiTinyMarginBegin sapUiTinyMarginEnd" />
                            <Button
                                icon="sap-icon://navigation-right-arrow"
                                press="onFilterNextPage"
                                enabled="{= ${filterModel>/pagination/currentPage} &lt; ${filterModel>/pagination/totalPages} }"
                                type="Transparent"
                            />
                            <ToolbarSpacer />
                            <Text text="Total: {filterModel>/filteredProductsCount} productos" class="sapUiTinyMarginBegin" />
                        </Toolbar>
                    </content>
                </Panel>

            </VBox>
        </content>

        <beginButton>
            <Button
                text="Agregar {filterModel>/selectedPresentacionesCount} Presentación(es)"
                type="Emphasized"
                press="onConfirmAddProducts"
                enabled="{= ${filterModel>/selectedPresentacionesCount} > 0 }"
            />
        </beginButton>
        <endButton>
            <Button
                text="Cancelar"
                press="onCancelAddProducts"
            />
        </endButton>
    </Dialog>
</core:FragmentDefinition>
