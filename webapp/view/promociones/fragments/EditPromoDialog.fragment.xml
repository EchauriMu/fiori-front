<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.ui.layout.form"
    xmlns:l="sap.ui.layout"
>
    <Dialog
        id="editPromoDialog"
        title="Editar Promoción"
        contentWidth="90%"
        contentHeight="85%"
        resizable="true"
        draggable="true"
        busy="{editPromoModel>/saving}"
        busyIndicatorDelay="0"
    >
        <content>
            <VBox class="sapUiSmallMargin">
                <!-- Mensaje de error -->
                <MessageStrip
                    id="editErrorStrip"
                    text="{editPromoModel>/errorMessage}"
                    type="Error"
                    showIcon="true"
                    visible="{= ${editPromoModel>/errorMessage} !== '' }"
                    class="sapUiSmallMarginBottom"
                />

                <!-- Header compacto con información -->
                <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiSmallMarginBottom sapUiSmallPadding">
                    <VBox>
                        <Title text="{editPromoModel>/IdPromoOK}" level="H5" />
                        <Text text="Creada por: {editPromoModel>/REGUSER} | Fecha: {path: 'editPromoModel>/REGDATE', formatter: '.formatDate'}" class="sapUiTinyText" />
                    </VBox>
                    <HBox alignItems="Center">
                        <ObjectStatus 
                            text="{path: 'editPromoModel>/', formatter: '.getPromotionStatus'}"
                            state="{path: 'editPromoModel>/', formatter: '.getPromotionStatusState'}"
                            class="sapUiMediumMarginEnd"
                        />
                        <Label text="Activa:" class="sapUiTinyMarginEnd" />
                        <Switch
                            state="{editPromoModel>/ACTIVED}"
                            change="onEditActivedChange"
                        />
                    </HBox>
                </HBox>

                <!-- Tabs de contenido -->
                <IconTabBar
                    id="editPromoTabs"
                    select="onEditTabSelect"
                >
                    <!-- Tab Detalles -->
                    <items>
                        <IconTabFilter text="Detalles" key="details" icon="sap-icon://detail-view">
                            <VBox class="sapUiSmallMargin">
                                
                                <!-- Información Básica -->
                                <f:SimpleForm
                                    editable="true"
                                    layout="ResponsiveGridLayout"
                                    labelSpanXL="3"
                                    labelSpanL="3"
                                    labelSpanM="3"
                                    labelSpanS="12"
                                    adjustLabelSpan="false"
                                    emptySpanXL="4"
                                    emptySpanL="4"
                                    emptySpanM="4"
                                    emptySpanS="0"
                                    columnsXL="1"
                                    columnsL="1"
                                    columnsM="1"
                                    singleContainerFullSize="false"
                                    class="sapUiSmallMarginBottom"
                                >
                                        <f:content>
                                            <Label text="Título" required="true" />
                                            <Input
                                                value="{editPromoModel>/Titulo}"
                                                placeholder="Título de la promoción"
                                                required="true"
                                            />

                                            <Label text="Descripción" />
                                            <TextArea
                                                value="{editPromoModel>/Descripcion}"
                                                rows="3"
                                                placeholder="Descripción de la promoción"
                                            />

                                            <Label text="Fecha de Inicio" required="true" />
                                            <DatePicker
                                                value="{editPromoModel>/FechaIni}"
                                                valueFormat="yyyy-MM-dd"
                                                displayFormat="dd/MM/yyyy"
                                                required="true"
                                            />

                                            <Label text="Fecha de Fin" required="true" />
                                            <DatePicker
                                                value="{editPromoModel>/FechaFin}"
                                                valueFormat="yyyy-MM-dd"
                                                displayFormat="dd/MM/yyyy"
                                                required="true"
                                            />
                                        </f:content>
                                    </f:SimpleForm>

                                <!-- Descuento -->
                                <f:SimpleForm
                                    editable="true"
                                    layout="ResponsiveGridLayout"
                                        labelSpanXL="3"
                                        labelSpanL="3"
                                        labelSpanM="3"
                                        labelSpanS="12"
                                        adjustLabelSpan="false"
                                        emptySpanXL="4"
                                        emptySpanL="4"
                                        emptySpanM="4"
                                        emptySpanS="0"
                                        columnsXL="1"
                                        columnsL="1"
                                        columnsM="1"
                                        singleContainerFullSize="false"
                                    >
                                        <f:content>
                                            <Label text="Tipo de Descuento" />
                                            <Select
                                                selectedKey="{editPromoModel>/TipoDescuento}"
                                                change="onEditTipoDescuentoChange"
                                            >
                                                <items>
                                                    <core:Item key="PORCENTAJE" text="Porcentaje (%)" />
                                                    <core:Item key="MONTO_FIJO" text="Monto Fijo ($)" />
                                                </items>
                                            </Select>

                                            <Label 
                                                text="Porcentaje de Descuento (%)" 
                                                visible="{= ${editPromoModel>/TipoDescuento} === 'PORCENTAJE' }"
                                            />
                                            <Input
                                                value="{editPromoModel>/DescuentoPorcentaje}"
                                                type="Number"
                                                placeholder="0 - 100"
                                                visible="{= ${editPromoModel>/TipoDescuento} === 'PORCENTAJE' }"
                                            />

                                            <Label 
                                                text="Monto de Descuento ($)" 
                                                visible="{= ${editPromoModel>/TipoDescuento} === 'MONTO_FIJO' }"
                                            />
                                            <Input
                                                value="{editPromoModel>/DescuentoMonto}"
                                                type="Number"
                                                placeholder="0.00"
                                                visible="{= ${editPromoModel>/TipoDescuento} === 'MONTO_FIJO' }"
                                            />
                                        </f:content>
                                    </f:SimpleForm>

                            </VBox>
                        </IconTabFilter>

                        <!-- Tab Productos -->
                        <IconTabFilter text="Productos" key="products" icon="sap-icon://product">
                            <VBox class="sapUiSmallMargin">
                                
                                <!-- Toolbar con acciones -->
                                <Toolbar>
                                    <Title text="Presentaciones en la Promoción ({editPromoModel>/ProductosAplicables/length})" level="H5" />
                                    <ToolbarSpacer />
                                    <Button
                                        text="Seleccionar Todo"
                                        icon="sap-icon://multiselect-all"
                                        press="onEditSelectAllProducts"
                                        visible="{= ${editPromoModel>/ProductosAplicables/length} > 0 }"
                                    />
                                    <Button
                                        text="Eliminar Seleccionados"
                                        icon="sap-icon://delete"
                                        type="Negative"
                                        press="onEditRemoveSelectedProducts"
                                        enabled="{= ${editPromoModel>/selectedProductsCount} > 0 }"
                                    />
                                    <Button
                                        text="Agregar Productos"
                                        icon="sap-icon://add"
                                        type="Emphasized"
                                        press="onEditOpenAddProducts"
                                    />
                                </Toolbar>

                                <!-- Buscador -->
                                <SearchField
                                    placeholder="Buscar por nombre, SKU o marca..."
                                    search="onEditSearchProducts"
                                    width="100%"
                                    class="sapUiSmallMarginTop"
                                />

                                <!-- Controles de paginación -->
                                <Toolbar class="sapUiSmallMarginTop">
                                    <ToolbarSpacer />
                                    <Label text="Productos por página:" class="sapUiTinyMarginEnd" />
                                    <Select
                                        selectedKey="{editPromoModel>/itemsPerPage}"
                                        change="onEditItemsPerPageChange"
                                        width="80px"
                                    >
                                        <items>
                                            <core:Item key="5" text="5" />
                                            <core:Item key="10" text="10" />
                                            <core:Item key="20" text="20" />
                                            <core:Item key="50" text="50" />
                                        </items>
                                    </Select>
                                    <ToolbarSpacer />
                                    <Button
                                        icon="sap-icon://navigation-left-arrow"
                                        press="onEditPreviousPage"
                                        enabled="{= ${editPromoModel>/currentPage} > 1 }"
                                        type="Transparent"
                                    />
                                    <Text text="Página {editPromoModel>/currentPage} de {editPromoModel>/totalPages}" class="sapUiTinyMarginBegin sapUiTinyMarginEnd" />
                                    <Button
                                        icon="sap-icon://navigation-right-arrow"
                                        press="onEditNextPage"
                                        enabled="{= ${editPromoModel>/currentPage} &lt; ${editPromoModel>/totalPages} }"
                                        type="Transparent"
                                    />
                                    <ToolbarSpacer />
                                </Toolbar>

                                <!-- Lista de productos agrupados -->
                                <List
                                    id="editProductsList"
                                    items="{path: 'editPromoModel>/paginatedGroupedProducts'}"
                                    mode="None"
                                    noDataText="No hay productos en esta promoción. Usa 'Agregar Productos' para incluirlos."
                                    class="sapUiSmallMarginTop"
                                >
                                    <items>
                                        <CustomListItem>
                                            <VBox width="100%" class="sapUiSmallMarginBottom">
                                                <!-- Producto principal - Header clickeable -->
                                                <HBox 
                                                    justifyContent="SpaceBetween" 
                                                    alignItems="Center" 
                                                    class="productHeader sapUiSmallPadding"
                                                >
                                                    <HBox alignItems="Center" width="40%">
                                                        <CheckBox
                                                            selected="{editPromoModel>allSelected}"
                                                            select="onEditProductCheckBoxSelect"
                                                            class="sapUiTinyMarginEnd"
                                                        />
                                                        <VBox width="100%">
                                                            <Text text="{editPromoModel>PRODUCTNAME}" class="sapUiTextBold" />
                                                            <Text 
                                                                text="SKU: {editPromoModel>SKUID}"
                                                                class="sapUiTinyText"
                                                            />
                                                        </VBox>
                                                    </HBox>
                                                    <HBox alignItems="Center" width="60%" justifyContent="End">
                                                        <Text 
                                                            text="{= ${editPromoModel>presentaciones}.length } presentación(es)" 
                                                            class="sapUiTinyMarginEnd"
                                                        />
                                                        <Button
                                                            type="Transparent"
                                                            press="onEditToggleProductExpansion"
                                                            icon="{= ${editPromoModel>expanded} ? 'sap-icon://navigation-down-arrow' : 'sap-icon://navigation-right-arrow' }"
                                                        />
                                                    </HBox>
                                                </HBox>

                                                <!-- Presentaciones expandidas -->
                                                <VBox 
                                                    visible="{editPromoModel>expanded}"
                                                    class="presentacionesContainer"
                                                >
                                                    <List
                                                        items="{path: 'editPromoModel>presentaciones'}"
                                                        noDataText="Sin presentaciones"
                                                        showSeparators="Inner"
                                                    >
                                                        <items>
                                                            <CustomListItem>
                                                                <HBox 
                                                                    justifyContent="SpaceBetween" 
                                                                    alignItems="Center" 
                                                                    width="100%"
                                                                    class="sapUiSmallPadding"
                                                                >
                                                                    <HBox alignItems="Center" width="60%" class="sapUiMediumMarginBegin">
                                                                        <CheckBox
                                                                            selected="{editPromoModel>selected}"
                                                                            select="onEditPresentacionSelect"
                                                                            class="sapUiTinyMarginEnd"
                                                                        />
                                                                        <VBox width="100%">
                                                                            <Text text="{editPromoModel>NOMBREPRESENTACION}" class="sapUiTextBold"/>
                                                                            <Text text="ID: {editPromoModel>IdPresentaOK}" class="sapUiTinyText" />
                                                                        </VBox>
                                                                    </HBox>
                                                                    <ObjectStatus
                                                                        text="$ {editPromoModel>Precio}"
                                                                        state="Success"
                                                                    />
                                                                </HBox>
                                                            </CustomListItem>
                                                        </items>
                                                    </List>
                                                </VBox>
                                            </VBox>
                                        </CustomListItem>
                                    </items>
                                </List>

                            </VBox>
                        </IconTabFilter>
                    </items>
                </IconTabBar>

            </VBox>
        </content>

        <buttons>
            <Button
                text="Eliminar Permanentemente"
                type="Reject"
                press="onEditDeleteHard"
                enabled="{= !${editPromoModel>/saving} }"
            />
            <Button
                text="Guardar Cambios"
                type="Emphasized"
                press="onEditSavePromotion"
                enabled="{= !${editPromoModel>/saving} }"
            />
            <Button
                text="Cancelar"
                press="onEditCloseDialog"
                enabled="{= !${editPromoModel>/saving} }"
            />
        </buttons>
    </Dialog>
</core:FragmentDefinition>
