<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.ui.layout.form"
>
    <Dialog
        title="Seleccionar Productos y Presentaciones"
        contentWidth="90%"
        contentHeight="80%"
        resizable="true"
        draggable="true"
    >
        <content>
            <VBox class="sapUiSmallMargin">
                <MessageStrip
                    text="Use los filtros para encontrar productos específicos. Seleccione las presentaciones que desea incluir en la promoción."
                    type="Information"
                    showIcon="true"
                    class="sapUiSmallMarginBottom"
                />

                <!-- Filtros -->
                <Panel headerText="Filtros de Búsqueda" expandable="true" expanded="true">
                    <f:SimpleForm
                        editable="true"
                        layout="ResponsiveGridLayout"
                        columnsL="2"
                        columnsM="1"
                    >
                        <f:content>
                            <Label text="Buscar Producto" />
                            <SearchField
                                placeholder="Nombre, SKU, marca..."
                                value="{filterModel>/searchTerm}"
                                search=".onFilterSearch"
                                width="100%"
                            />

                            <Label text="Categoría" />
                            <MultiComboBox
                                placeholder="Seleccionar categorías..."
                                items="{filterModel>/allCategories}"
                                selectionChange=".onFilterCategoryChange"
                            >
                                <!-- Ajusta IdCategoriaOK/Descripcion a los campos reales de categoría -->
                                <core:Item key="{filterModel>IdCategoriaOK}" text="{filterModel>Descripcion}" />
                            </MultiComboBox>

                            <Label text="Marca" />
                            <MultiComboBox
                                placeholder="Seleccionar marcas..."
                                items="{filterModel>/allBrands}"
                                selectionChange=".onFilterBrandChange"
                            >
                                <core:Item key="{filterModel>id}" text="{filterModel>name}" />
                            </MultiComboBox>

                            <Label text="Rango de Precio" />
                            <HBox>
                                <Input
                                    type="Number"
                                    placeholder="Mín"
                                    value="{filterModel>/filters/precioMin}"
                                    width="100px"
                                    liveChange=".onFilterPriceChange"
                                />
                                <Label text="-" class="sapUiTinyMarginBegin sapUiTinyMarginEnd" />
                                <Input
                                    type="Number"
                                    placeholder="Máx"
                                    value="{filterModel>/filters/precioMax}"
                                    width="100px"
                                    liveChange=".onFilterPriceChange"
                                />
                            </HBox>
                        </f:content>
                    </f:SimpleForm>
                    <Toolbar>
                        <ToolbarSpacer />
                        <Button text="Aplicar Filtros" type="Emphasized" press=".onFilterSearch" />
                        <Button text="Limpiar" press=".onClearFilters" />
                    </Toolbar>
                </Panel>

                <!-- Productos encontrados -->
                <Panel 
                    headerText="Productos Encontrados ({filterModel>/filteredProductsCount})" 
                    class="sapUiSmallMarginTop"
                >
                    <Toolbar>
                        <Title text="Seleccionados: {filterModel>/selectedCount}" level="H5" />
                        <ToolbarSpacer />
                        <Button 
                            text="Seleccionar Todos" 
                            press=".onSelectAllProducts"
                        />
                        <Button 
                            text="Deseleccionar Todos" 
                            press=".onDeselectAllProducts"
                        />
                    </Toolbar>

                    <List
                        items="{filterModel>/filteredProducts}"
                        mode="None"
                        includeItemInSelection="false"
                        growing="true"
                        growingThreshold="20"
                    >
                        <CustomListItem>
                            <VBox class="sapUiSmallMargin">
                                <HBox justifyContent="SpaceBetween">
                                    <VBox>
                                        <Title level="H6" text="{filterModel>PRODUCTNAME}" />
                                        <Text text="SKU: {filterModel>SKUID} | Marca: {filterModel>MARCA}" />
                                    </VBox>
                                    <Button
                                        icon="sap-icon://navigation-down-arrow"
                                        type="Transparent"
                                        press=".onFilterToggleProduct"
                                    />
                                </HBox>

                                <!-- Presentaciones (mostrar cuando se expanda) -->
                                <VBox visible="{filterModel>expanded}" class="sapUiSmallMarginTop">
                                    <Title level="H6" text="Presentaciones" />
                                    <List
                                        items="{filterModel>presentaciones}"
                                        mode="None"
                                    >
                                        <StandardListItem
                                            title="{filterModel>NOMBREPRESENTACION}"
                                            description="{filterModel>Descripcion}"
                                            info="$ {filterModel>precio}"
                                            infoState="Success"
                                            selected="{filterModel>selected}"
                                            type="Active"
                                            press=".onPresentacionPress"
                                        />
                                    </List>
                                </VBox>
                            </VBox>
                        </CustomListItem>
                    </List>
                </Panel>
            </VBox>
        </content>
        
        <buttons>
            <Button text="Cancelar" press=".onCancelAddProducts" />
            <Button 
                text="Confirmar Selección ({filterModel>/selectedPresentacionesCount})" 
                type="Emphasized" 
                press=".onConfirmAddProducts"
            />
        </buttons>
    </Dialog>
</core:FragmentDefinition>
