<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.ui.layout.form"
>
    <Dialog
        title="Seleccionar Productos y Presentaciones"
        contentWidth="90%"
        contentHeight="80%"
        resizable="true"
        draggable="true"
    >
        <content>
            <VBox class="sapUiSmallMargin">
                <MessageStrip
                    text="Use los filtros para encontrar productos específicos. Seleccione las presentaciones que desea incluir en la promoción."
                    type="Information"
                    showIcon="true"
                    class="sapUiSmallMarginBottom"
                />

                <!-- Filtros -->
                <Panel headerText="Filtros de Búsqueda" expandable="true" expanded="true">
                    <f:SimpleForm
                        editable="true"
                        layout="ResponsiveGridLayout"
                        columnsL="2"
                        columnsM="1"
                    >
                        <f:content>
                            <Label text="Buscar Producto" />
                            <SearchField
                                placeholder="Nombre, SKU, marca..."
                                value="{filterModel>/searchTerm}"
                                search=".onFilterSearch"
                                width="100%"
                            />

                            <Label text="Categoría" />
                            <MultiComboBox
                                placeholder="Seleccionar categorías..."
                                items="{filterModel>/allCategories}"
                                selectedKeys="{filterModel>/filters/categorias}"
                                selectionChange=".onFilterCategoryChange"
                            >
                                <core:Item key="{filterModel>CATID}" text="{filterModel>Nombre}" />
                            </MultiComboBox>

                            <Label text="Marca" />
                            <MultiComboBox
                                placeholder="Seleccionar marcas..."
                                items="{filterModel>/allBrands}"
                                selectedKeys="{filterModel>/filters/marcas}"
                                selectionChange=".onFilterBrandChange"
                            >
                                <core:Item key="{filterModel>id}" text="{filterModel>name}" />
                            </MultiComboBox>

                            <Label text="Rango de Precio" />
                            <HBox>
                                <Input
                                    type="Number"
                                    placeholder="Mín"
                                    value="{filterModel>/filters/precioMin}"
                                    width="100px"
                                    liveChange=".onFilterPriceChange"
                                />
                                <Label text="-" class="sapUiTinyMarginBegin sapUiTinyMarginEnd" />
                                <Input
                                    type="Number"
                                    placeholder="Máx"
                                    value="{filterModel>/filters/precioMax}"
                                    width="100px"
                                    liveChange=".onFilterPriceChange"
                                />
                            </HBox>
                        </f:content>
                    </f:SimpleForm>
                    <Toolbar>
                        <ToolbarSpacer />
                        <Button text="Limpiar" press=".onClearFilters" />
                    </Toolbar>
                </Panel>

                <!-- Productos encontrados -->
                <Panel 
                    headerText="Productos Encontrados ({filterModel>/filteredProductsCount})" 
                    class="sapUiSmallMarginTop"
                >
                    <Toolbar>
                        <Title text="Seleccionados: {filterModel>/selectedPresentacionesCount}" level="H5" />
                        <ToolbarSpacer />
                        <Button 
                            text="Seleccionar Todos" 
                            press=".onSelectAllProducts"
                        />
                        <Button 
                            text="Deseleccionar Todos" 
                            press=".onClearSelection"
                        />
                    </Toolbar>

                    <List
                        items="{filterModel>/filteredProducts}"
                        mode="None"
                        includeItemInSelection="false"
                        growing="true"
                        growingThreshold="20"
                    >
                        <CustomListItem>
                            <VBox class="sapUiSmallMargin" width="95%">
                                <!-- PRODUCTO CON CHECKBOX -->
                                <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%" class="productHeader sapUiSmallPadding">
                                    <HBox alignItems="Center" width="40%">
                                        <CheckBox
                                            selected="{filterModel>allSelected}"
                                            select=".onFilterProductCheckBoxSelect"
                                            class="sapUiTinyMarginEnd"
                                        />
                                        <VBox width="100%">
                                            <Title level="H6" text="{filterModel>PRODUCTNAME}" />
                                            <Text text="SKU: {filterModel>SKUID} | Marca: {filterModel>MARCA}" />
                                        </VBox>
                                    </HBox>
                                    <HBox alignItems="Center" width="60%" justifyContent="End">
                                        <Text text="{= ${filterModel>presentaciones}.length || 0 } presentación(es)" class="sapUiTinyMarginEnd"/>
                                        <Button
                                            type="Transparent"
                                            press=".onFilterToggleProduct"
                                            icon="{= ${filterModel>expanded} ? 'sap-icon://navigation-down-arrow' : 'sap-icon://navigation-right-arrow' }"
                                        />
                                    </HBox>
                                </HBox>

                                <!-- PRESENTACIONES CON INDENTACIÓN -->
                                <VBox visible="{= ${filterModel>expanded} === true }" class="presentacionesContainer">
                                    <List
                                        items="{filterModel>presentaciones}"
                                        mode="None"
                                        showSeparators="Inner"
                                    >
                                        <CustomListItem>
                                            <HBox alignItems="Center" width="100%" class="sapUiSmallPadding sapUiMediumMarginBegin">
                                                <CheckBox 
                                                    selected="{filterModel>selected}"
                                                    enabled="{= !${filterModel>locked} }"
                                                    select=".onFilterPresentacionSelect"
                                                    class="sapUiTinyMarginEnd"
                                                />
                                                <VBox width="70%">
                                                    <Text text="{filterModel>NOMBREPRESENTACION}" class="sapUiTextBold"/>
                                                    <Text text="ID: {filterModel>IdPresentaOK}" class="sapUiTinyText"/>
                                                </VBox>
                                                <HBox alignItems="Center">
                                                    <ObjectStatus text="$ {filterModel>precio}" state="Success"/>
                                                    <core:Icon 
                                                        src="sap-icon://locked" 
                                                        visible="{filterModel>locked}"
                                                        color="#999"
                                                        class="sapUiTinyMarginStart"
                                                    />
                                                </HBox>
                                            </HBox>
                                        </CustomListItem>
                                    </List>
                                </VBox>
                            </VBox>
                        </CustomListItem>
                    </List>
                </Panel>
            </VBox>
        </content>
        
        <buttons>
            <Button text="Cancelar" press=".onCancelAddProducts" />
            <Button 
                text="Confirmar Selección ({filterModel>/selectedPresentacionesCount})" 
                type="Emphasized" 
                press=".onConfirmAddProducts"
            />
        </buttons>
    </Dialog>
</core:FragmentDefinition>
