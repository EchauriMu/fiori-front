<mvc:View
    controllerName="com.invertions.sapfiorimodinv.controller.promociones.Calendario"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:l="sap.ui.layout"
    xmlns:core="sap.ui.core"
    xmlns:u="sap.ui.unified"
>
    <Page
        id="calendarioPage"
        title="Calendario de Promociones"
        showNavButton="true"
        navButtonPress="onNavBack"
    >
        <content>
            <VBox class="sapUiMediumMargin">
                <!-- Header con controles -->
                <Panel>
                    <FlexBox wrap="Wrap" justifyContent="SpaceBetween" class="sapUiSmallMargin">
                        <!-- Filtros -->
                        <VBox class="sapUiSmallMarginEnd" width="23%">
                            <Label text="Estado" />
                                <Select
                                    selectedKey="{calendarModel>/filters/estado}"
                                    change="onFilterChange"
                                    width="100%"
                                >
                                    <core:Item key="all" text="Todas" />
                                    <core:Item key="Activa" text="Activas" />
                                    <core:Item key="Programada" text="Programadas" />
                                    <core:Item key="Expirada" text="Expiradas" />
                                    <core:Item key="Inactiva" text="Inactivas" />
                                </Select>
                        </VBox>

                        <VBox class="sapUiSmallMarginEnd" width="23%">
                            <Label text="Buscar" />
                                <SearchField
                                    value="{calendarModel>/filters/search}"
                                    search="onFilterChange"
                                    placeholder="Nombre de promoción..."
                                    width="100%"
                                />
                        </VBox>

                        <VBox class="sapUiSmallMarginEnd" width="23%">
                            <Label text="Vista" />
                                <SegmentedButton
                                    selectedKey="{calendarModel>/viewMode}"
                                    selectionChange="onViewModeChange"
                                >
                                    <items>
                                        <SegmentedButtonItem key="month" text="Mes" icon="sap-icon://calendar" />
                                        <SegmentedButtonItem key="agenda" text="Agenda" icon="sap-icon://list" />
                                    </items>
                                </SegmentedButton>
                        </VBox>

                        <VBox class="sapUiSmallMarginTop" width="23%">
                            <Button
                                text="Exportar CSV"
                                icon="sap-icon://excel-attachment"
                                press="onExport"
                                type="Emphasized"
                            />
                        </VBox>
                    </FlexBox>
                </Panel>

                <!-- Vista Mensual -->
                <Panel visible="{= ${calendarModel>/viewMode} === 'month' }" class="sapUiMediumMarginTop">
                    <headerToolbar>
                        <OverflowToolbar>
                            <Title text="{calendarModel>/currentMonthYear}" level="H3" />
                            <ToolbarSpacer />
                            <Button
                                icon="sap-icon://navigation-left-arrow"
                                press="onPreviousMonth"
                                type="Transparent"
                            />
                            <Button
                                text="Hoy"
                                press="onToday"
                                type="Transparent"
                            />
                            <Button
                                icon="sap-icon://navigation-right-arrow"
                                press="onNextMonth"
                                type="Transparent"
                            />
                        </OverflowToolbar>
                    </headerToolbar>

                    <content>
                        <VBox>
                            <!-- Días de la semana -->
                            <HBox class="calendar-header">
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Dom" class="calendar-day-header" />
                                </VBox>
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Lun" class="calendar-day-header" />
                                </VBox>
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Mar" class="calendar-day-header" />
                                </VBox>
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Mié" class="calendar-day-header" />
                                </VBox>
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Jue" class="calendar-day-header" />
                                </VBox>
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Vie" class="calendar-day-header" />
                                </VBox>
                                <VBox width="14.28%" alignItems="Center">
                                    <Text text="Sáb" class="calendar-day-header" />
                                </VBox>
                            </HBox>

                            <!-- Días del mes -->
                            <VBox 
                                class="calendar-grid"
                                id="calendarGrid"
                            >
                                <!-- Los días se generarán dinámicamente en el controlador -->
                            </VBox>
                        </VBox>
                    </content>
                </Panel>

                <!-- Vista Agenda -->
                <Panel visible="{= ${calendarModel>/viewMode} === 'agenda' }" class="sapUiMediumMarginTop">
                    <headerToolbar>
                        <Toolbar>
                            <Title text="Agenda de Promociones" level="H3" />
                            <ToolbarSpacer />
                            <Text text="{calendarModel>/filteredPromotions/length} promociones" />
                        </Toolbar>
                    </headerToolbar>

                    <content>
                        <List
                            items="{calendarModel>/filteredPromotions}"
                            noDataText="No hay promociones que coincidan con los filtros"
                            growing="true"
                            growingThreshold="20"
                        >
                            <CustomListItem type="Navigation" press="onPromotionPress">
                                <VBox class="sapUiSmallMargin">
                                    <HBox justifyContent="SpaceBetween" alignItems="Start">
                                        <HBox alignItems="Center" class="sapUiTinyMarginEnd" width="70%">
                                            <core:Icon
                                                src="sap-icon://calendar"
                                                size="2.5rem"
                                                color="{path: 'calendarModel>', formatter: '.getPromotionColor'}"
                                                class="sapUiMediumMarginEnd"
                                            />
                                            <VBox width="100%">
                                                <Title level="H5" text="{calendarModel>Titulo}" wrapping="true" />
                                                <Text 
                                                    text="{calendarModel>Descripcion}" 
                                                    class="sapUiTinyMarginTop"
                                                    maxLines="2"
                                                />
                                                <HBox class="sapUiTinyMarginTop">
                                                    <ObjectStatus
                                                        text="{path: 'calendarModel>FechaIni', formatter: '.formatDate'} - {path: 'calendarModel>FechaFin', formatter: '.formatDate'}"
                                                        state="None"
                                                        icon="sap-icon://date-time"
                                                    />
                                                </HBox>
                                            </VBox>
                                        </HBox>

                                        <VBox alignItems="End">
                                            <ObjectStatus
                                                text="{path: 'calendarModel>', formatter: '.getPromotionStatusText'}"
                                                state="{path: 'calendarModel>', formatter: '.getPromotionStatusState'}"
                                            />
                                            <VBox alignItems="End" class="sapUiTinyMarginTop">
                                                <HBox>
                                                    <VBox alignItems="Center" class="sapUiTinyMarginEnd">
                                                        <Text text="Descuento" class="sapUiTinyText" />
                                                        <ObjectNumber
                                                            number="{calendarModel>DescuentoPorcentaje}"
                                                            unit="%"
                                                            emphasized="true"
                                                        />
                                                    </VBox>
                                                    <VBox alignItems="Center">
                                                        <Text text="Presentaciones" class="sapUiTinyText" />
                                                        <ObjectNumber
                                                            number="{= ${calendarModel>ProductosAplicables} ? ${calendarModel>ProductosAplicables}.length : 0 }"
                                                            emphasized="true"
                                                        />
                                                    </VBox>
                                                </HBox>
                                            </VBox>
                                        </VBox>
                                    </HBox>

                                    <HBox class="sapUiSmallMarginTop">
                                        <ObjectStatus
                                            text="Creado por: {calendarModel>REGUSER}"
                                            state="Information"
                                            icon="sap-icon://employee"
                                        />
                                        <ObjectStatus
                                            text="{path: 'calendarModel>REGDATE', formatter: '.formatDate'}"
                                            state="None"
                                            class="sapUiTinyMarginBegin"
                                        />
                                    </HBox>
                                </VBox>
                            </CustomListItem>
                        </List>
                    </content>
                </Panel>
            </VBox>
        </content>
    </Page>

    <!-- Dialog de Detalle de Promoción -->
    <Dialog
        id="promoDetailDialog"
        contentWidth="900px"
        contentHeight="700px"
        resizable="true"
        draggable="true"
        title="{detailModel>/Titulo}"
    >
        <content>
            <ScrollContainer height="100%" width="100%" vertical="true">
                <VBox class="sapUiSmallMargin">
                    <!-- Header Info -->
                    <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiMediumMarginBottom">
                        <HBox alignItems="Center">
                            <core:Icon
                                src="sap-icon://product"
                                size="2.5rem"
                                color="{path: 'detailModel>/', formatter: '.getPromotionColor'}"
                                class="sapUiSmallMarginEnd"
                            />
                            <VBox>
                                <Title level="H3" text="{detailModel>/Titulo}" wrapping="true" />
                                <ObjectStatus
                                    text="{path: 'detailModel>/', formatter: '.getPromotionStatusText'}"
                                    state="{path: 'detailModel>/', formatter: '.getPromotionStatusState'}"
                                    class="sapUiTinyMarginTop"
                                />
                            </VBox>
                        </HBox>
                    </HBox>

                    <!-- Descripción -->
                    <VBox class="sapUiSmallMarginBottom">
                        <Label text="Descripción" class="sapUiTinyMarginBottom" design="Bold" />
                        <Text text="{detailModel>/Descripcion}" wrapping="true" />
                    </VBox>

                    <!-- Fechas -->
                    <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                        <VBox width="48%">
                            <Label text="Fecha de Inicio" class="sapUiTinyMarginBottom" design="Bold" />
                            <Text 
                                text="{path: 'detailModel>/FechaIni', formatter: '.formatDateFull'}"
                                wrapping="true"
                            />
                        </VBox>
                        <VBox width="48%">
                            <Label text="Fecha de Fin" class="sapUiTinyMarginBottom" design="Bold" />
                            <Text 
                                text="{path: 'detailModel>/FechaFin', formatter: '.formatDateFull'}"
                                wrapping="true"
                            />
                        </VBox>
                    </HBox>

                    <!-- Descuento y Productos -->
                    <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                        <VBox width="48%">
                            <Label text="Descuento" class="sapUiTinyMarginBottom" design="Bold" />
                            <HBox alignItems="Center">
                                <ObjectNumber
                                    number="{detailModel>/DescuentoPorcentaje}"
                                    unit="%"
                                    emphasized="true"
                                    state="Success"
                                    class="sapUiTinyMarginEnd"
                                />
                                <Text text="({detailModel>/TipoDescuento})" />
                            </HBox>
                        </VBox>
                        <VBox width="48%">
                            <Label text="Presentaciones" class="sapUiTinyMarginBottom" design="Bold" />
                            <ObjectNumber
                                number="{= ${detailModel>/ProductosAplicables} ? ${detailModel>/ProductosAplicables}.length : 0 }"
                                emphasized="true"
                            />
                        </VBox>
                    </HBox>

                    <!-- Lista de Productos con Presentaciones -->
                    <VBox 
                        class="sapUiSmallMarginTop"
                        visible="{= ${detailModel>/groupedProducts} &amp;&amp; ${detailModel>/groupedProducts}.length > 0 }"
                    >
                        <Label text="Productos Incluidos" class="sapUiSmallMarginBottom" design="Bold" />
                        <List
                            items="{detailModel>/groupedProducts}"
                            noDataText="No hay productos"
                            mode="None"
                        >
                            <CustomListItem>
                                <VBox width="100%">
                                    <HBox justifyContent="SpaceBetween" alignItems="Center" width="100%">
                                        <HBox alignItems="Center" width="80%">
                                            <core:Icon src="sap-icon://product" size="1.5rem" class="sapUiTinyMarginEnd" color="#0854a0" />
                                            <VBox>
                                                <Text text="{detailModel>NombreProducto}" class="sapUiTextBold" />
                                                <Text text="SKU: {detailModel>SKUID}" style="font-size: 0.75rem; color: #6a6d70;" />
                                            </VBox>
                                        </HBox>
                                        <ObjectStatus 
                                            text="{= ${detailModel>presentaciones}.length } presentación(es)" 
                                            state="Information"
                                        />
                                    </HBox>
                                </VBox>
                            </CustomListItem>
                        </List>
                    </VBox>

                    <!-- Información Adicional -->
                    <VBox class="sapUiSmallMarginTop">
                        <Label text="Información Adicional" class="sapUiSmallMarginBottom" design="Bold" />
                        <VBox class="sapUiSmallPadding" style="background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                            <HBox justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                <Text text="Creado por:" class="sapUiTinyText" />
                                <Text text="{detailModel>/REGUSER}" />
                            </HBox>
                            <HBox justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                <Text text="Fecha de creación:" class="sapUiTinyText" />
                                <Text text="{path: 'detailModel>/REGDATE', formatter: '.formatDate'}" />
                            </HBox>
                            <HBox 
                                justifyContent="SpaceBetween"
                                visible="{= !!${detailModel>/MODDATE} }"
                            >
                                <Text text="Última modificación:" class="sapUiTinyText" />
                                <Text text="{path: 'detailModel>/MODDATE', formatter: '.formatDate'}" />
                            </HBox>
                        </VBox>
                    </VBox>
                </VBox>
            </ScrollContainer>
        </content>

        <buttons>
            <Button text="Cerrar" press="onCloseDetailDialog" type="Emphasized" />
        </buttons>
    </Dialog>
</mvc:View>
