<mvc:View
    controllerName="com.invertions.sapfiorimodinv.controller.promociones.CrearPromocion"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.ui.layout.form"
    xmlns:l="sap.ui.layout"
    xmlns:core="sap.ui.core"
>
    <Page 
        id="crearPromocionPage" 
        title="Crear Nueva Promoción - {createPromo>/currentStepTitle}" 
        showNavButton="true" 
        navButtonPress=".onNavBack"
    >
        <content>
            <!-- Indicador de progreso -->
            <ProgressIndicator
                percentValue="{createPromo>/progressPercent}"
                displayValue="Paso {createPromo>/currentStep} de 3"
                showValue="true"
                state="Information"
                class="sapUiSmallMarginBottom"
            />
            
            <!-- Contenedor de navegación para los pasos -->
            <NavContainer 
                id="stepNavContainer"
                autoFocus="false"
                height="100%"
            >
                <!-- PASO 1: INFORMACIÓN GENERAL Y DESCUENTO -->
                <Page
                    id="InfoStepPage"
                    showHeader="false"
                    enableScrolling="true"
                    class="sapUiResponsivePadding--content"
                >
                    <MessageStrip
                        text="Complete la información básica de la promoción y configure el descuento. El ID se generará automáticamente."
                        type="Information"
                        showIcon="true"
                        class="sapUiSmallMarginBottom"
                    />
                    
                    <f:SimpleForm
                        editable="true"
                        layout="ResponsiveGridLayout"
                        labelSpanXL="4"
                        labelSpanL="3"
                        labelSpanM="4"
                        labelSpanS="12"
                        emptySpanXL="0"
                        emptySpanL="4"
                        emptySpanM="0"
                        emptySpanS="0"
                        columnsXL="2"
                        columnsL="1"
                        columnsM="1"
                    >
                        <f:content>
                            <core:Title text="Información de la Promoción" />

                            <Label text="Plantilla" />
                            <Select 
                                selectedKey="{createPromo>/plantilla}" 
                                change=".onPlantillaChange"
                                width="100%"
                            >
                                <core:Item key="" text="Seleccionar plantilla..." />
                                <core:Item key="black-friday" text="Black Friday" />
                                <core:Item key="navidad" text="Navidad" />
                                <core:Item key="flash-sale" text="Flash Sale" />
                                <core:Item key="lanzamiento" text="Lanzamiento" />
                                <core:Item key="personalizado" text="Personalizado" />
                            </Select>

                            <Label text="Título" required="true" />
                            <Input 
                                id="tituloInput"
                                value="{createPromo>/titulo}" 
                                liveChange=".onPromoInputChange"
                                placeholder="Ej: Black Friday 2025"
                                valueState="{= ${createPromo>/errors/titulo} ? 'Error' : 'None' }"
                            />

                            <Label text="Descripción" required="true" />
                            <TextArea 
                                value="{createPromo>/descripcion}" 
                                liveChange=".onPromoInputChange"
                                placeholder="Descripción de la promoción"
                                valueState="{= ${createPromo>/errors/descripcion} ? 'Error' : 'None' }"
                                rows="3"
                                width="100%"
                            />

                            <Label text="Fecha de Inicio" required="true" />
                            <DatePicker 
                                value="{createPromo>/fechaInicio}"
                                change=".onPromoInputChange"
                                valueState="{= ${createPromo>/errors/fechaInicio} ? 'Error' : 'None' }"
                                displayFormat="dd/MM/yyyy"
                            />

                            <Label text="Fecha de Fin" required="true" />
                            <DatePicker 
                                value="{createPromo>/fechaFin}"
                                change=".onPromoInputChange"
                                valueState="{= ${createPromo>/errors/fechaFin} ? 'Error' : 'None' }"
                                displayFormat="dd/MM/yyyy"
                            />

                            <core:Title text="Configuración de Descuento" />

                            <Label text="Tipo de Descuento" required="true" />
                            <Select 
                                selectedKey="{createPromo>/tipoDescuento}" 
                                change=".onTipoDescuentoChange"
                                width="100%"
                            >
                                <core:Item key="PORCENTAJE" text="Porcentaje (%)" />
                                <core:Item key="MONTO_FIJO" text="Monto Fijo ($)" />
                            </Select>

                            <Label 
                                text="Porcentaje de Descuento (%)" 
                                required="true"
                                visible="{= ${createPromo>/tipoDescuento} === 'PORCENTAJE' }"
                            />
                            <Input 
                                type="Number"
                                value="{createPromo>/descuentoPorcentaje}" 
                                liveChange=".onPromoInputChange"
                                min="0"
                                max="100"
                                step="0.1"
                                visible="{= ${createPromo>/tipoDescuento} === 'PORCENTAJE' }"
                                valueState="{= ${createPromo>/errors/descuentoPorcentaje} ? 'Error' : 'None' }"
                            />

                            <Label 
                                text="Monto de Descuento ($)" 
                                required="true"
                                visible="{= ${createPromo>/tipoDescuento} === 'MONTO_FIJO' }"
                            />
                            <Input 
                                type="Number"
                                value="{createPromo>/descuentoMonto}" 
                                liveChange=".onPromoInputChange"
                                min="0"
                                step="0.01"
                                visible="{= ${createPromo>/tipoDescuento} === 'MONTO_FIJO' }"
                                valueState="{= ${createPromo>/errors/descuentoMonto} ? 'Error' : 'None' }"
                            />

                            <core:Title text="Reglas Adicionales" />

                            <Label text="Permite Acumulación" />
                            <CheckBox 
                                selected="{createPromo>/permiteAcumulacion}"
                                text="Permite acumular con otras promociones"
                            />

                            <Label text="Límite de Usos (opcional)" />
                            <Input 
                                type="Number"
                                value="{createPromo>/limiteUsos}" 
                                placeholder="Sin límite"
                                min="1"
                            />
                        </f:content>
                    </f:SimpleForm>
                </Page>

                <!-- PASO 2: SELECCIÓN DE PRODUCTOS/PRESENTACIONES -->
                <Page
                    id="ProductsStepPage"
                    showHeader="false"
                    enableScrolling="false"
                >
                    <VBox height="100%">
                        <MessageStrip
                            text="Seleccione los productos y presentaciones a los que se aplicará la promoción. Puede usar filtros para facilitar la selección."
                            type="Information"
                            showIcon="true"
                            class="sapUiSmallMarginBottom"
                        />
                        
                        <!-- Fragmento Unificado de Filtros Avanzados -->
                        <core:Fragment fragmentName="com.invertions.sapfiorimodinv.view.promociones.fragments.AdvancedFilters" type="XML"/>
                    </VBox>
                </Page>

                <!-- PASO 3: REVISIÓN -->
                <Page
                    id="ReviewStepPage"
                    showHeader="false"
                    enableScrolling="true"
                    class="sapUiResponsivePadding--content"
                >
                    <MessageStrip
                        text="Revise toda la información antes de crear la promoción."
                        type="Warning"
                        showIcon="true"
                        class="sapUiSmallMarginBottom"
                    />
                    
                    <VBox>
                        <Title level="H4" text="Información General" class="sapUiSmallMarginTopBottom" />
                        <f:SimpleForm
                            editable="false"
                            layout="ResponsiveGridLayout"
                            labelSpanXL="4" 
                            labelSpanL="3" 
                            labelSpanM="4" 
                            labelSpanS="12"
                        >
                            <f:content>
                                <Label text="Título" />
                                <Text text="{createPromo>/titulo}" />
                                
                                <Label text="Descripción" />
                                <Text text="{createPromo>/descripcion}" wrapping="true"/>
                                
                                <Label text="Vigencia" />
                                <Text text="{path: 'createPromo>/fechaInicio', formatter: '.formatDate'} - {path: 'createPromo>/fechaFin', formatter: '.formatDate'}" />
                                
                                <Label text="Tipo de Descuento" />
                                <Text text="{createPromo>/tipoDescuento}" />
                                
                                <Label text="Descuento" />
                                <Text text="{= ${createPromo>/tipoDescuento} === 'PORCENTAJE' ? ${createPromo>/descuentoPorcentaje} + '%' : '$' + ${createPromo>/descuentoMonto} }" />
                                
                                <Label text="Permite Acumulación" />
                                <Text text="{= ${createPromo>/permiteAcumulacion} ? 'Sí' : 'No' }" />
                                
                                <Label text="Límite de Usos" />
                                <Text text="{= ${createPromo>/limiteUsos} ? ${createPromo>/limiteUsos} : 'Sin límite' }" />
                            </f:content>
                        </f:SimpleForm>

                        <Title level="H4" text="Presentaciones ({createPromo>/paginationSelected/totalItems})" class="sapUiMediumMarginTop sapUiTinyMarginBottom"/>
                        
                        <!-- Controles de paginación -->
                        <Toolbar class="sapUiTinyMarginTop">
                            <ToolbarSpacer />
                            <Label text="Productos por página:" class="sapUiTinyMarginEnd" />
                            <Select
                                selectedKey="{createPromo>/paginationSelected/itemsPerPage}"
                                change=".onSelectedItemsPerPageChange"
                                width="80px"
                            >
                                <items>
                                    <core:Item key="5" text="5" />
                                    <core:Item key="10" text="10" />
                                    <core:Item key="20" text="20" />
                                    <core:Item key="50" text="50" />
                                </items>
                            </Select>
                            <ToolbarSpacer />
                            <Button
                                icon="sap-icon://navigation-left-arrow"
                                press=".onSelectedPreviousPage"
                                enabled="{= ${createPromo>/paginationSelected/currentPage} > 1 }"
                                type="Transparent"
                            />
                            <Text text="Página {createPromo>/paginationSelected/currentPage} de {createPromo>/paginationSelected/totalPages}" class="sapUiTinyMarginBegin sapUiTinyMarginEnd" />
                            <Button
                                icon="sap-icon://navigation-right-arrow"
                                press=".onSelectedNextPage"
                                enabled="{= ${createPromo>/paginationSelected/currentPage} &lt; ${createPromo>/paginationSelected/totalPages} }"
                                type="Transparent"
                            />
                            <ToolbarSpacer />
                        </Toolbar>
                        
                        <List 
                            items="{createPromo>/paginatedSelectedProducts}" 
                            noDataText="No se agregaron presentaciones."
                            class="sapUiSmallMarginTop"
                        >
                            <CustomListItem>
                                <VBox width="100%" class="sapUiSmallMarginBottom">
                                    <!-- Encabezado del Producto -->
                                    <HBox 
                                        justifyContent="SpaceBetween" 
                                        alignItems="Center" 
                                        class="sapUiSmallPadding"
                                        style="background-color: rgba(0, 0, 0, 0.05); border-radius: 4px; cursor: pointer;"
                                    >
                                        <HBox alignItems="Center" width="80%">
                                            <core:Icon src="sap-icon://product" class="sapUiTinyMarginEnd" color="#0854a0" />
                                            <VBox width="100%">
                                                <Text text="{createPromo>PRODUCTNAME}" class="sapUiTextBold" style="font-size: 1rem;"/>
                                                <HBox alignItems="Center">
                                                    <Text text="SKU: {createPromo>SKUID}" class="sapUiTinyText sapUiTinyMarginEnd" style="color: #6a6d70;"/>
                                                    <ObjectStatus 
                                                        text="{= ${createPromo>presentaciones}.length } presentación(es)" 
                                                        state="Information"
                                                    />
                                                </HBox>
                                            </VBox>
                                        </HBox>
                                        <Button
                                            type="Transparent"
                                            press=".onToggleGroupedProduct"
                                            icon="{= ${createPromo>expanded} ? 'sap-icon://navigation-down-arrow' : 'sap-icon://navigation-right-arrow' }"
                                            tooltip="{= ${createPromo>expanded} ? 'Colapsar' : 'Expandir' }"
                                        />
                                    </HBox>
                                    
                                    <!-- Lista de Presentaciones -->
                                    <VBox visible="{createPromo>expanded}" class="sapUiTinyMarginTop sapUiSmallMarginBegin">
                                        <List
                                            items="{createPromo>presentaciones}"
                                            showSeparators="None"
                                            backgroundDesign="Transparent"
                                        >
                                            <CustomListItem>
                                                <HBox 
                                                    justifyContent="SpaceBetween" 
                                                    alignItems="Center" 
                                                    width="100%"
                                                    class="sapUiTinyPadding"
                                                    style="min-height: 2rem;"
                                                >
                                                    <HBox alignItems="Center" width="80%">
                                                        <core:Icon src="sap-icon://accept" size="0.8rem" class="sapUiTinyMarginEnd" color="#2da54a" />
                                                        <VBox>
                                                            <Text text="{createPromo>NOMBREPRESENTACION}" style="font-size: 0.875rem;"/>
                                                            <Text text="ID: {createPromo>IdPresentaOK}" style="font-size: 0.75rem; color: #6a6d70;"/>
                                                        </VBox>
                                                    </HBox>
                                                    <Text text="${createPromo>Precio}" style="font-size: 0.875rem; color: #2da54a; font-weight: 600;"/>
                                                </HBox>
                                            </CustomListItem>
                                        </List>
                                    </VBox>
                                </VBox>
                            </CustomListItem>
                        </List>
                    </VBox>
                </Page>
            </NavContainer>
        </content>
        
        <footer>
            <Toolbar>
                <Button 
                    id="btnAnterior"
                    text="Anterior" 
                    icon="sap-icon://navigation-left-arrow"
                    press=".onPreviousStep"
                    visible="{= ${createPromo>/currentStep} !== 1 }"
                />
                <ToolbarSpacer />
                <Button text="Cancelar" press=".onNavBack" />
                <Button 
                    id="btnSiguiente"
                    text="Siguiente" 
                    icon="sap-icon://navigation-right-arrow"
                    iconFirst="false"
                    type="Emphasized"
                    press=".onNextStep"
                    visible="{= ${createPromo>/currentStep} !== 3 }"
                />
                <Button 
                    id="btnCrear"
                    text="Crear Promoción" 
                    type="Accept"
                    icon="sap-icon://save"
                    press=".onSavePromotion"
                    visible="{= ${createPromo>/currentStep} === 3 }"
                />
            </Toolbar>
        </footer>
    </Page>
</mvc:View>
